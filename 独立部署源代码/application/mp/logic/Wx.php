<?php
 namespace app\mp\logic; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\logic\Defs as IndexDefs; use app\mp\service\Subjects; use app\Defs; use app\index\logic\Subject as SubjectLogic; use EasyWeChat\Factory; use app\mp\service\Users; use app\index\logic\Expert as ExpertLogic; use app\index\logic\AppointOrder as AppointOrderLogic; use app\index\service\EventLogs as EventLogsService; use app\index\logic\Sms as SmsLogic; class Wx extends Base { public function webOauth($code, $referer_url) { goto k6G3x; LnoG7: $refererUrl = htmlspecialchars_decode($referer_url); goto dYrLS; l7VjT: stC9R: goto UaJOx; NCxoE: Log::notice("\167\x65\142\117\141\165\164\x68\x20\x73\165\x63\143\x65\163\163\x20\x74\x6f\x20\x70\165\154\x6c\x20\x72\x65\x66\x65\x72\145\x72\137\x75\162\x6c\x20{$refererUrl}"); goto XeQje; gc0jE: goto stC9R; goto FWpA1; dYrLS: if ($refererUrl) { goto gdDsF; } goto Hdtmc; Hdtmc: Log::error("\167\145\142\117\141\x75\x74\x68\40\146\141\151\154\145\x64\x20\164\157\x20\x70\165\x6c\x6c\40\162\x65\x66\x65\162\x65\x72\137\x75\x72\x6c"); goto TQpgN; FWpA1: gdDsF: goto NCxoE; XeQje: return $refererUrl; goto l7VjT; k6G3x: try { goto eS_Nm; HXLV3: $userInfo = $user->toArray(); goto JjGL6; IXdY2: $wxUser = Users::I()->saveUserFromWx($userInfo["\162\141\167"]); goto fRd5h; DDdYd: $user = $app->oauth->userFromCode($code); goto HXLV3; JjGL6: Log::notice("\127\170\x20\x6f\x61\x75\164\150\40\162\145\164\165\x72\156\40\x75\x73\x65\x72\x3a\40" . var_export($userInfo, true)); goto anyEn; qrtcE: Users::I()->setLoginSession($wxUser); goto VCA6I; fRd5h: goto Ot9y6; goto sHSLn; jbyD9: $wxUser = Users::I()->saveUserFromWx($userInfo["\x72\x61\167"]); goto vjmNK; sHSLn: dUhEA: goto jbyD9; eS_Nm: $app = \EasyWeChat\Factory::officialAccount(config("\x77\170\x2e\x6f\146\x66\151\x63\x69\x61\x6c\x5f\x61\x63\143\157\x75\x6e\164")); goto DDdYd; vjmNK: Ot9y6: goto qrtcE; anyEn: if (empty($userInfo["\x69\163\137\x73\x6e\141\160\163\150\x6f\x74\x75\x73\x65\x72"])) { goto dUhEA; } goto IXdY2; VCA6I: } catch (\Exception $e) { Log::error("\x77\x65\142\117\x61\x75\164\150\40\x66\141\151\x6c\x65\x64\x20\164\157\40\143\x72\145\x61\164\x65\57\165\160\144\141\x74\145\40\x75\163\x65\x72\x2c\x20\x65\162\162\x6f\x72\x3a" . $e->getMessage()); wexception("\xe5\276\xae\xe4\xbf\241\347\224\250\346\x88\267\346\x8e\210\346\235\x83\345\244\xb1\xe8\xb4\xa5\x2c\40\x6d\163\147\x3a\x20" . $e->getMessage()); } goto LnoG7; TQpgN: return "\155\x70\57\x49\x6e\144\145\170\57\151\x6e\144\x65\x78"; goto gc0jE; UaJOx: } public function events() { goto fQVyp; J2CEM: $app->server->push(function ($message) { goto f5Qi6; C56se: gWfZF: goto pb45Z; enTfl: switch ($message["\x4d\163\x67\x54\171\x70\x65"]) { case "\x65\x76\x65\156\x74": goto QGtJr; lS5gc: $event_key = $message["\105\x76\x65\x6e\164\113\x65\x79"]; goto G1a3v; mx5Nw: SG85r: goto wEK6Y; riArX: hXlsQ: goto FbUGd; DuUCB: goto gWfZF; goto w6jw9; Hzxcv: lh1fQ: goto ib8xm; lVmoD: $msg = $reply; goto Hzxcv; ydHgO: switch ($arr[0]) { case "\x74\145\x73\x74": $msg = $this->replySubjectLink($arr[2]); goto hXlsQ; case "\145\170\160\x65\x72\164": $msg = $this->replyExpertLink($arr[2]); goto hXlsQ; case "\143\x6f\155\142\x69\x6e\141\x74\151\157\156": $msg = $this->replyCombinationLink($arr[2]); goto hXlsQ; case "\101\x69\157\102\151\x6e\x64\x52\x65\x70\x6f\162\164": $msg = $this->replyReportLink($arr[1], $message["\x46\x72\157\x6d\x55\x73\145\x72\x4e\x61\x6d\x65"]); goto hXlsQ; } goto C74Ht; G1a3v: $reply = Db::table("\x77\x78\137\x6d\x65\x6e\165\163")->where(["\x6b\x65\171" => $event_key])->value("\155\x73\147"); goto TMNuu; wEK6Y: if (!($message["\x45\166\145\x6e\x74\x4b\145\171"] && $message["\x54\151\143\153\145\164"])) { goto VtV7B; } goto PvI2v; C74Ht: IZGz2: goto riArX; H4506: if (!($message["\105\166\145\156\164"] == "\103\114\x49\103\x4b")) { goto flCjJ; } goto lS5gc; PvI2v: $arr = explode("\x5f", str_replace("\x71\162\x73\143\145\156\x65\x5f", '', $message["\x45\166\x65\x6e\x74\x4b\x65\171"])); goto ydHgO; FbUGd: VtV7B: goto YPT0c; YPT0c: F740e: goto DuUCB; TFOf5: goto F740e; goto mx5Nw; ib8xm: flCjJ: goto TFOf5; QGtJr: if ($message["\x45\166\145\x6e\164"] == "\x73\165\x62\163\143\x72\x69\142\145" || $message["\105\x76\145\x6e\164"] == "\x53\x43\x41\116") { goto SG85r; } goto H4506; TMNuu: if (!$reply) { goto lh1fQ; } goto lVmoD; w6jw9: default: } goto UePng; pb45Z: return $msg; goto gvNUo; f5Qi6: $msg = "\163\165\x63\143\x65\163\163"; goto KrfoT; KrfoT: Log::notice("\x57\x78\x20\x65\x76\x65\x6e\x74\163\72\x20" . var_export($message, true)); goto enTfl; UePng: cqe9h: goto C56se; gvNUo: }); goto MlMd7; MlMd7: $response = $app->server->serve(); goto HjTea; HjTea: $response->send(); goto sExsa; fQVyp: $app = \EasyWeChat\Factory::officialAccount(config("\x77\170\x2e\x6f\146\146\x69\x63\151\x61\154\x5f\141\143\x63\x6f\x75\x6e\x74")); goto J2CEM; sExsa: } protected function replySubjectLink($subject_id) { goto whxfK; ktWuf: return new \EasyWeChat\Kernel\Messages\News($items); goto t5Up_; whxfK: $subject = Subjects::I()->getSubjectById($subject_id); goto d4YpC; KHrQd: ponC9: goto CM_FN; KtSCg: return "\x73\165\x63\143\x65\x73\163"; goto KHrQd; CM_FN: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\164\151\x74\x6c\145" => $subject["\156\x61\155\145"], "\x64\x65\163\143\162\x69\x70\x74\x69\157\156" => "\xe7\202\271\345\x87\273\345\274\x80\xe5\xa7\213\xe6\xb5\213\xe8\257\204", "\165\x72\154" => url("\x6d\160\x2f\x53\165\142\x6a\x65\143\x74\57\x64\145\x74\x61\x69\x6c", ["\x69\144" => $subject_id], false, true), "\x69\x6d\x61\x67\145" => generateUploadFullUrl($subject["\x69\155\141\x67\x65\137\x75\162\x6c"])])]; goto ktWuf; d4YpC: if (!empty($subject)) { goto ponC9; } goto KtSCg; t5Up_: } protected function replyCombinationLink($id) { goto DTDt0; jfm6j: rTTyr: goto TeCBK; ShFD4: return new \EasyWeChat\Kernel\Messages\News($items); goto D2Df0; TeCBK: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\164\151\x74\x6c\x65" => $row["\156\141\x6d\145"], "\x64\145\x73\x63\x72\151\160\164\x69\x6f\156" => "\xe7\x82\271\xe5\207\xbb\xe5\274\200\xe5\247\x8b\xe6\xb5\x8b\xe8\xaf\204", "\165\x72\154" => url("\x6d\x70\x2f\x53\x75\142\x6a\145\x63\164\57\x63\157\155\142\151\x6e\141\164\151\x6f\x6e\137\x74\x65\x73\x74", ["\x63\x6f\155\142\x69\156\141\x74\x69\x6f\156\137\151\x64" => $id], false, true), "\x69\x6d\x61\x67\145" => generateUploadFullUrl($row["\142\x61\156\x6e\x65\162"])])]; goto ShFD4; mTrcR: return "\x73\x75\x63\143\x65\x73\x73"; goto jfm6j; DTDt0: $row = Db::table("\x73\165\142\152\145\143\164\x5f\x63\157\x6d\x62\x69\x6e\141\164\151\x6f\x6e")->where(["\x69\144" => $id])->find(); goto x3178; x3178: if (!empty($row)) { goto rTTyr; } goto mTrcR; D2Df0: } protected function replyExpertLink($expert_id) { goto t1WzT; bxJMR: if (!empty($expert)) { goto z83J0; } goto xzhMH; bdL4X: z83J0: goto YRgGD; MCxYf: return new \EasyWeChat\Kernel\Messages\News($items); goto kE22b; xzhMH: return "\163\165\x63\143\145\x73\163"; goto bdL4X; YRgGD: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\164\x69\x74\x6c\145" => $expert["\x72\x65\x61\154\137\x6e\x61\x6d\x65"], "\x64\x65\163\x63\x72\151\160\x74\151\157\156" => "\347\202\271\xe5\207\xbb\346\x9f\245\347\x9c\213\344\xb8\x93\345\xae\266", "\165\162\x6c" => url("\155\x70\x2f\105\x78\160\145\162\164\57\x64\145\x74\x61\x69\154", ["\x65\x78\160\145\x72\164\x49\x64" => $expert_id], false, true), "\x69\155\141\x67\x65" => generateUploadFullUrl($expert["\x77\x6f\x72\153\151\155\147\x5f\x75\162\x6c"])])]; goto MCxYf; t1WzT: $expert = ExpertLogic::I()->getInfos($expert_id); goto bxJMR; kE22b: } protected function replyReportLink($order_no, $open_id) { goto s7De_; OIlmi: return new \EasyWeChat\Kernel\Messages\News($items); goto O1vlc; s7De_: $order = Subjects::I()->getOrderByNo($order_no); goto QmNnD; QmNnD: if (!empty($order)) { goto sN2h9; } goto TO8yK; fjpkt: $items = [new \EasyWeChat\Kernel\Messages\NewsItem(["\x74\151\164\x6c\x65" => $subject["\x6e\141\x6d\145"], "\x64\x65\x73\143\x72\x69\x70\164\x69\157\156" => "\347\202\xb9\xe5\207\273\346\x9f\xa5\xe7\x9c\x8b\346\265\213\350\257\225\346\212\xa5\xe5\x91\212", "\165\162\154" => url("\155\x70\57\123\165\x62\x6a\145\143\164\57\x72\x65\160\x6f\162\164", ["\x6f\162\x64\145\162\x5f\x6e\x6f" => $order_no, "\142\151\x6e\144\x5f\157\160\145\x6e\151\144" => $open_id], false, true), "\151\x6d\x61\x67\145" => generateUploadFullUrl($subject["\x69\155\141\147\x65\137\x75\162\154"])])]; goto OIlmi; TO8yK: return "\163\x75\x63\143\145\x73\x73"; goto NO5St; NO5St: sN2h9: goto Rv0W0; Rv0W0: $subject = Subjects::I()->getSubjectById($order["\x73\165\x62\152\145\x63\x74\137\151\x64"]); goto fjpkt; O1vlc: } public function paidSubjectOrder() { goto OUtm0; CQLnH: $app = Factory::payment(config("\167\x78\56\160\141\171\155\145\x6e\164")); goto yHpy0; yHpy0: $response = $app->handlePaidNotify(function ($msg, $fail) { goto W2Msa; mwgNB: return $fail("\xe9\x80\232\344\xbf\xa1\xe5\xa4\261\xe8\264\245\xef\xbc\x8c\xe8\257\267\347\250\x8d\xe5\220\216\345\206\x8d\xe9\200\232\347\x9f\xa5\346\x88\221"); goto iAmpi; raUoj: quIYC: goto gRqr3; CYxME: ISkMQ: goto s1y5L; iAmpi: nFVtu: goto kH9lB; T9A04: if (!($msg["\162\x65\164\165\x72\x6e\137\x63\x6f\144\x65"] == "\x46\101\111\114")) { goto nFVtu; } goto mwgNB; s1y5L: $save = []; goto YB8jj; alu3r: $this->saveTransaction(1, $msg); goto uYh2s; XZ03P: $save["\160\x61\171\137\x73\x74\x61\164\165\x73"] = Defs::PAY_FAIL; goto pKlxX; W2Msa: file_put_contents(LOG_PATH . "\x77\x78\x5f\160\x61\x79\56\x6c\157\x67", var_export($msg, true), FILE_APPEND); goto T9A04; HhYrU: qtzQp: goto u3WLS; X0zPC: if ($msg["\x72\x65\163\165\154\164\137\x63\x6f\144\x65"] == "\x53\125\x43\x43\x45\x53\123") { goto quIYC; } goto XZ03P; u3WLS: Db::table("\163\x75\142\x6a\145\x63\164\137\x6f\x72\x64\x65\x72")->where(["\x6f\x72\144\145\162\x5f\x6e\157" => $order["\x6f\x72\x64\145\162\x5f\156\x6f"]])->update($save); goto alu3r; YB8jj: $save["\156\157\164\x69\146\x79\137\164\x69\x6d\x65"] = date("\x59\55\155\x2d\x64\40\110\x3a\x69\x3a\x73"); goto X0zPC; pKlxX: goto qtzQp; goto raUoj; kH9lB: $order = Subjects::I()->getOrderByNo($msg["\x6f\165\164\x5f\164\x72\141\144\x65\x5f\x6e\157"]); goto JM2Hp; JM2Hp: if (!(empty($order) || $order["\160\x61\x79\x5f\163\x74\141\x74\x75\x73"] == Defs::PAY_SUCCESS)) { goto ISkMQ; } goto EHNNO; gRqr3: $save["\160\141\171\137\x73\164\141\164\x75\163"] = Defs::PAY_SUCCESS; goto NkxKN; NkxKN: $save["\160\x61\171\x5f\x74\151\155\145"] = date("\131\x2d\x6d\55\x64\40\x48\x3a\151\x3a\x73", strtotime($msg["\x74\x69\155\x65\137\x65\x6e\x64"])); goto HhYrU; uYh2s: return true; goto SV361; EHNNO: return true; goto CYxME; SV361: }); goto PN6xF; PN6xF: $response->send(); goto Z1Jkf; OUtm0: wxPaySetting(); goto CQLnH; Z1Jkf: } public function paidExpertOrder() { goto HRNFX; JhaSj: $response->send(); goto pqC2q; Q1Q5U: $response = $app->handlePaidNotify(function ($msg, $fail) { goto SvHnN; D9QdF: return true; goto gDID6; eXmP8: if ($msg["\x72\145\163\x75\154\164\x5f\143\157\144\x65"] == "\123\x55\103\103\x45\123\123") { goto ZPRB9; } goto fUjzI; SvHnN: file_put_contents(LOG_PATH . "\x77\170\x5f\160\141\171\x2e\x6c\157\x67", var_export($msg, true), FILE_APPEND); goto lrEQq; i7nvN: $save["\160\141\x79\x5f\x73\x74\141\164\165\163"] = Defs::PAY_SUCCESS; goto SY85z; qFWV4: $appointTimeSms = convertAppointTimesToShow($order["\141\x70\160\157\151\x6e\164\137\164\x69\155\145"]); goto XUPWJ; XUPWJ: $smsResult = SmsLogic::I()->sendAppoitOrderToCustomer($order["\143\x65\154\x6c\160\150\x6f\156\145"], date("\155\346\x9c\210\144\xe6\x97\xa5", strtotime($order["\x61\160\x70\157\x69\156\x74\x5f\144\141\164\145"])) . "\40" . $appointTimeSms, systemSetting("\x61\x70\x70\x6f\151\156\164\137\x6f\x72\x64\x65\162\x5f\x6f\x66\x66\151\x63\x65\x5f\141\x64\144\162\x65\x73\x73")); goto iXC39; CZ1Av: nZ4ep: goto oLZos; Cc4zu: DpIxq: goto DgwzK; gDID6: S66Bh: goto DTYXZ; ZJwJJ: goto tzVPB; goto QzhUk; CKB9F: if (!(systemSetting("\163\x65\156\144\137\141\160\160\x6f\x69\156\164\x5f\157\x72\x64\145\162\x5f\164\157\x5f\143\165\x73\x74\157\155\x65\162") == "\x79\x65\163")) { goto bDRV2; } goto qFWV4; i0tU_: if (!($order["\x73\x74\x61\164\x75\x73"] == IndexDefs::ORDER_PENDING_STATUS)) { goto iAgDQ; } goto q_qvI; bZQsx: $this->saveTransaction(2, $msg); goto IOYVF; QzhUk: ZPRB9: goto i7nvN; IOYVF: return true; goto yxbE7; lrEQq: if (!($msg["\162\x65\164\x75\162\156\137\143\x6f\144\145"] == "\106\101\x49\x4c")) { goto DpIxq; } goto JQMsN; DTYXZ: $save = []; goto nuQKN; u1nBp: tzVPB: goto i0tU_; fUjzI: $save["\x70\x61\x79\x5f\x73\x74\x61\164\x75\163"] = Defs::PAY_FAIL; goto ZJwJJ; JIaPy: if (!($order["\x73\164\x61\x74\165\163"] == IndexDefs::ORDER_PENDING_STATUS)) { goto vZtQp; } goto CKB9F; iXC39: if ($smsResult) { goto nZ4ep; } goto GQ3Az; vvcce: iAgDQ: goto OReMl; SY85z: $save["\x70\141\x79\x5f\164\x69\155\x65"] = date("\x59\55\155\55\x64\x20\110\72\151\x3a\163", strtotime($msg["\164\151\x6d\x65\x5f\x65\156\144"])); goto u1nBp; xVt5q: if (!(empty($order) || $order["\160\x61\x79\137\163\164\x61\164\x75\x73"] == Defs::PAY_SUCCESS)) { goto S66Bh; } goto D9QdF; q_qvI: $save["\x73\164\x61\164\x75\x73"] = IndexDefs::ORDER_APPOINTED_STATUS; goto vvcce; DgwzK: $order = AppointOrderLogic::I()->getInfos($msg["\157\165\x74\137\164\162\x61\144\145\137\x6e\x6f"]); goto xVt5q; JQMsN: return $fail("\351\x80\232\344\277\xa1\xe5\244\xb1\xe8\264\xa5\357\274\x8c\350\xaf\267\347\xa8\x8d\345\220\x8e\xe5\x86\x8d\xe9\x80\232\xe7\237\xa5\xe6\x88\221"); goto Cc4zu; GQ3Az: logEvent("\xe5\217\221\351\x80\x81\351\242\x84\xe7\xba\xa6\xe9\x80\x9a\347\x9f\245\347\237\255\344\277\241\xe5\210\xb0\xe5\xae\242\xe6\210\xb7{$order["\x63\145\x6c\154\x70\x68\x6f\156\x65"]}\345\xa4\xb1\xe8\xb4\245", EventLogsService::eSeverityError); goto KXp2J; QtcLC: vZtQp: goto bZQsx; oLZos: bDRV2: goto QtcLC; KXp2J: Log::error("\146\x61\x69\x6c\x65\144\40\x74\x6f\40\x73\x65\x6e\144\40\x73\155\163\40\x74\157\40\143\165\163\x74\x6f\155\x65\162\40{$order["\143\x65\x6c\x6c\x70\x68\157\156\x65"]}"); goto CZ1Av; OReMl: Db::table("\x65\x78\160\x65\x72\164\x5f\x6f\x72\144\x65\162")->where(["\157\x72\144\145\x72\137\156\x6f" => $order["\157\x72\144\145\x72\x5f\156\x6f"]])->update($save); goto JIaPy; nuQKN: $save["\x6e\157\x74\x69\x66\171\x5f\x74\x69\155\145"] = date("\x59\x2d\x6d\x2d\144\x20\110\72\x69\72\x73"); goto eXmP8; yxbE7: }); goto JhaSj; HRNFX: wxPaySetting(); goto tqMjW; tqMjW: $app = Factory::payment(config("\x77\170\56\160\x61\171\x6d\145\x6e\x74")); goto Q1Q5U; pqC2q: } protected function saveTransaction($fee_type, $msg) { goto fCjCr; bcw8f: BFr7Y: goto B2DYN; UVSaJ: if ($row) { goto BFr7Y; } goto DFZan; p5oAV: sShhc: goto kCajs; fCjCr: $row = Db::table("\x74\x72\x61\156\163\x61\143\x74\x69\157\156\x73")->where(["\157\x72\x64\x65\162\x5f\156\x6f" => $msg["\157\x75\x74\137\164\162\x61\144\x65\137\156\x6f"], "\x66\x65\x65\137\x74\x79\160\145" => $fee_type])->field("\151\x64")->find(); goto UVSaJ; DFZan: Db::table("\x74\162\x61\x6e\163\x61\143\x74\151\x6f\x6e\163")->insert(["\157\162\x64\x65\162\x5f\x6e\157" => $msg["\157\165\164\137\x74\162\141\144\145\137\x6e\x6f"], "\x66\145\x65\137\x74\x79\x70\x65" => $fee_type, "\164\157\x74\x61\x6c\137\x66\x65\x65" => $msg["\164\157\x74\x61\x6c\x5f\146\145\x65"], "\x63\150\141\156\156\145\154" => $msg["\x6d\x63\x68\x5f\x69\144"] == Defs::WZYER_WXPAY_MCH_ID ? 1 : 2, "\x70\x61\x79\x6c\157\141\x64" => json_encode($msg, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_SLASHES)]); goto OWKKK; B2DYN: Db::table("\x74\x72\141\x6e\163\141\143\x74\x69\157\x6e\x73")->where(["\157\162\x64\x65\x72\137\156\157" => $msg["\157\165\x74\137\x74\162\x61\144\145\x5f\156\x6f"], "\x66\145\145\137\x74\171\160\x65" => $fee_type])->update(["\x74\x6f\164\141\x6c\137\x66\x65\x65" => $msg["\164\x6f\164\141\x6c\137\x66\x65\x65"], "\143\x68\x61\x6e\x6e\145\x6c" => $msg["\155\143\150\x5f\x69\144"] == Defs::WZYER_WXPAY_MCH_ID ? 1 : 2, "\160\x61\171\154\157\x61\x64" => json_encode($msg, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_SLASHES)]); goto p5oAV; OWKKK: goto sShhc; goto bcw8f; kCajs: } }
