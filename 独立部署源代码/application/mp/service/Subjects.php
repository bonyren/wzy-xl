<?php
 namespace app\mp\service; use app\Defs; use think\Db; use think\Log; use app\index\logic\Defs as IndexDefs; use app\index\logic\Subject as SubjectLogic; use app\mp\service\RequestContext; use app\common\service\Redis as RedisService; class Subjects extends Bases { public function getList($map = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $paging = false) { goto Vq72A; rA_SK: x1PdC: goto ecssA; tqVMu: if (emptyInArray($search, "\156\141\155\145")) { goto xu6Pn; } goto le_06; T8JfH: $where["\x64\145\x6c\x65\x74\x65\137\146\x6c\141\x67"] = 0; goto R3EqJ; MZPXg: $records = Db::table("\163\165\142\x6a\x65\143\x74")->field($field)->where($where)->page($page, $rows)->order($order)->select(); goto YJvVq; OnxBj: return ["\x74\x6f\x74\141\154" => 0, "\x72\x6f\x77\x73" => []]; goto cv1_f; w30SA: return $records; goto dQCrB; I5Jqf: if (!$paging) { goto PfFYR; } goto OnxBj; YJvVq: if (empty($paging)) { goto lDnFK; } goto ZNPSb; JJDNh: return []; goto rA_SK; ZNPSb: $total = Db::table("\163\165\x62\152\145\x63\x74")->where($where)->count(); goto LJk2w; R3EqJ: $where["\x73\x74\x61\164\165\163"] = ["\151\x6e", [IndexDefs::ENTITY_PUBLISH_STATUS]]; goto Vd_rT; AXPq5: xu6Pn: goto KNmrs; LJk2w: return ["\x74\157\164\x61\154" => $total, "\x72\157\x77\163" => $records]; goto nOhmg; dxNMZ: if (emptyInArray($search, "\x63\x61\164\x65\147\157\x72\x79\x5f\x69\144")) { goto v42CU; } goto lDoky; KWD6S: zMEFr: goto VBYca; ecssA: JrUu5: goto vl4Sn; PmHME: if (!($search =& $map["\163\145\x61\162\143\150"])) { goto mjaaA; } goto A2mPq; KNmrs: if (emptyInArray($search, "\x6c\x61\142\145\154")) { goto zMEFr; } goto Ivblr; Sc8Fg: AmiBh: goto dxNMZ; ZEl4w: $where["\164\171\x70\x65"] = $search["\x74\x79\160\x65"]; goto Sc8Fg; pVfSW: v42CU: goto tqVMu; A2mPq: if (emptyInArray($search, "\164\171\160\145")) { goto AmiBh; } goto ZEl4w; Q4oyZ: $field = isset($map["\x66\x69\x65\x6c\144"]) ? $map["\x66\x69\145\x6c\x64"] : "\x2a"; goto PmHME; Ivblr: $where["\x6c\141\x62\145\154"] = ["\154\x69\x6b\145", "\x25{$search["\x6c\141\x62\145\154"]}\45"]; goto KWD6S; vfhBs: if (!empty($subjectIds)) { goto JrUu5; } goto I5Jqf; cv1_f: goto x1PdC; goto iFZGy; iFZGy: PfFYR: goto JJDNh; VBYca: mjaaA: goto T8JfH; Vd_rT: $order = empty($map["\x6f\x72\144\145\x72"]) ? "\x73\157\x72\x74\x20\141\x73\143\x2c\151\x64\x20\144\x65\163\x63" : $map["\157\162\x64\145\162"]; goto MZPXg; vl4Sn: $where["\x69\x64"] = ["\151\156", $subjectIds]; goto pVfSW; Vq72A: $where = isset($map["\167\150\145\162\x65"]) ? $map["\167\x68\x65\x72\145"] : []; goto Q4oyZ; dQCrB: x5G1h: goto tX_98; nOhmg: goto x5G1h; goto H32mN; H32mN: lDnFK: goto w30SA; lDoky: $subjectIds = Db::table("\x73\x75\x62\x6a\145\x63\164\137\x63\141\x74\145\x67\157\162\171\137\x72\145\x6c\x61\x74\x65")->where(["\x63\141\x74\x65\x67\157\x72\171\x5f\151\144" => $search["\143\141\x74\145\x67\x6f\x72\171\137\x69\144"]])->column("\x73\165\142\x6a\145\x63\x74\x5f\x69\x64"); goto vfhBs; le_06: $where["\x6e\x61\155\x65"] = ["\x6c\151\153\x65", "\x25{$search["\x6e\x61\155\x65"]}\x25"]; goto AXPq5; tX_98: } public function getSubjectById($id) { goto jDKI4; Pxjin: return Db::table("\163\x75\x62\152\x65\143\x74")->where(["\151\144" => $id])->field(true)->find(); goto vxcgx; YiknA: return null; goto pqqC0; jDKI4: if (!empty($id)) { goto kJhuJ; } goto YiknA; pqqC0: kJhuJ: goto Pxjin; vxcgx: } public function collect($uid, $subject_id, $type) { goto HQyp2; HQyp2: if (!($type == 0)) { goto vLW9B; } goto skZRx; w57aY: vLW9B: goto i9shf; ABs40: GohP9: goto kxoK3; WTkwb: Db::table("\x73\x75\142\152\145\143\164\x5f\143\x6f\x6c\154\x65\x63\x74")->insert(["\143\x75\x73\x74\x6f\x6d\x65\x72\x5f\151\x64" => $uid, "\x73\x75\x62\152\x65\143\164\x5f\151\x64" => $subject_id]); goto ABs40; i9shf: if ($this->isCollected($uid, $subject_id)) { goto GohP9; } goto WTkwb; ltPzt: return; goto w57aY; skZRx: Db::table("\163\165\x62\152\145\x63\164\x5f\143\157\154\154\x65\143\x74")->where(["\x63\x75\x73\164\x6f\x6d\x65\162\137\151\144" => $uid, "\163\x75\x62\152\145\143\164\137\x69\144" => $subject_id])->delete(); goto ltPzt; kxoK3: } public function isCollected($uid, $subject_id) { return (bool) Db::table("\x73\165\142\x6a\145\143\x74\137\x63\157\154\154\145\x63\x74")->where(["\143\x75\x73\x74\x6f\155\145\162\x5f\151\144" => $uid, "\x73\x75\x62\152\x65\143\164\x5f\151\144" => $subject_id])->value("\x69\144"); } public function getCategories() { return Db::table("\143\x61\x74\145\x67\157\x72\x69\145\x73")->order("\151\x64\x20\x61\x73\x63")->column("\x69\144\54\156\x61\x6d\x65\54\163\164\141\164\x75\x73\54\x69\x6d\x67\137\165\x72\154"); } public function getUnFinishTest($uid, $subject_id, $cb_order_id = 0, $survey_order_id = 0) { goto WEK5q; hUxI2: $order = Db::table("\x73\x75\x62\x6a\145\x63\164\137\157\x72\144\x65\162")->where($where)->order("\x6f\x72\x64\145\x72\x5f\x74\151\155\x65\40\144\x65\163\143")->find(); goto YyY4X; BuPik: jeF5K: goto GM4Vc; YyY4X: if ($order && !$order["\x66\x69\156\151\x73\150\x65\x64"]) { goto za1MQ; } goto tlPfk; NGVrW: return $order; goto BuPik; tlPfk: return null; goto F_XL1; WEK5q: $where = ["\143\x75\163\x74\x6f\155\145\x72\137\151\x64" => $uid, "\x73\x75\x62\x6a\145\143\x74\137\151\144" => $subject_id, "\160\141\x79\x5f\163\164\x61\x74\165\x73" => Defs::PAY_SUCCESS, "\143\142\137\157\162\144\x65\x72\137\151\144" => $cb_order_id, "\x73\x75\x72\x76\x65\x79\137\157\162\x64\x65\162\x5f\x69\x64" => $survey_order_id]; goto hUxI2; njqR2: za1MQ: goto NGVrW; F_XL1: goto jeF5K; goto njqR2; GM4Vc: } public function getOrderByNo($order_no) { goto KkeDt; UzB1w: GGH23: goto d0uLc; Jypn4: $result = json_decode($row["\162\x65\163\165\x6c\164"], true); goto epKYT; ZkGJn: $row = Db::table("\163\165\142\152\x65\x63\x74\137\157\162\144\145\162")->where(["\x6f\x72\144\145\162\137\156\157" => $order_no])->field(true)->find(); goto UlxQh; UlxQh: if (!($row && !empty($row["\x72\145\163\x75\x6c\x74"]))) { goto GGH23; } goto Jypn4; d0uLc: return $row; goto D7Yvn; hql4r: goto VR_cZ; goto AvnVc; Dq2Gf: $row["\162\x65\160\157\x72\x74\x5f\154\x69\163\164"] = $result["\162\x65\x70\x6f\162\x74\114\x69\163\164"]; goto PK3pn; snoCn: NGXYM: goto ZkGJn; LyaeX: $row["\162\145\160\x6f\162\164\137\x6c\151\x73\x74"] = []; goto hql4r; E61S9: return null; goto snoCn; AvnVc: OoDz9: goto Dq2Gf; PK3pn: VR_cZ: goto UzB1w; pdNP3: Log::error("\146\x61\151\x6c\x65\144\x20\164\x6f\40\x64\x65\x63\157\144\145\x20\x72\145\x73\165\154\164\x20\146\x6f\162\x20\163\x75\142\152\145\143\x74\x20\x6f\x72\144\145\x72\x3a\40{$order_no}"); goto LyaeX; epKYT: if ($result && isset($result["\162\145\x70\157\162\x74\114\151\163\164"])) { goto OoDz9; } goto pdNP3; KkeDt: if (!empty($order_no)) { goto NGXYM; } goto E61S9; D7Yvn: } public function getOrderById($id) { goto NQq2H; e_hnJ: $row["\x72\x65\160\x6f\162\164\137\x6c\151\163\164"] = []; goto a24nc; oz9Ev: return $row; goto a8ATa; Icj2I: $row = Db::table("\163\x75\x62\152\x65\x63\x74\x5f\157\162\x64\145\162")->where(["\151\144" => $id])->field(true)->find(); goto iJErD; oAHw_: nJnU3: goto oz9Ev; NQq2H: if (!empty($id)) { goto GQEck; } goto JNqjL; kg98m: $row["\x72\x65\x70\x6f\162\x74\x5f\154\151\x73\164"] = $result["\162\145\x70\x6f\162\164\114\151\163\x74"]; goto aFWZ9; aFWZ9: LFVrh: goto oAHw_; rFkqA: if ($result && isset($result["\162\x65\160\157\162\x74\x4c\x69\x73\164"])) { goto aWQh5; } goto qtwBD; iJErD: if (!($row && !empty($row["\162\x65\x73\165\154\164"]))) { goto nJnU3; } goto n4ehB; y1is7: aWQh5: goto kg98m; qtwBD: Log::error("\x66\141\x69\154\145\x64\40\x74\157\x20\x64\145\x63\x6f\144\x65\40\x72\145\x73\165\154\164\x20\146\x6f\x72\40\163\x75\142\x6a\x65\143\x74\40\x69\x64\x3a\x20{$id}"); goto e_hnJ; Q4JR5: GQEck: goto Icj2I; n4ehB: $result = json_decode($row["\x72\145\163\x75\154\164"], true); goto rFkqA; JNqjL: return null; goto Q4JR5; a24nc: goto LFVrh; goto y1is7; a8ATa: } public function generateOrder($uid, $subject_id, $channel = Defs::CHANNEL_WX, $cb_order_id = 0, $survey_order_id = 0) { goto lq2P0; sZqTP: $order["\157\x72\144\x65\x72\x5f\156\157"] = generateSequenceNo($uid, Defs::SUBJECT_ORDER_NO_SEQ_NUM_KEY, "\x53"); goto D9M7A; ikOg0: Da0N0: goto uWo_q; JuGQ_: $orderAmount = $subject["\143\165\x72\162\145\x6e\x74\x5f\160\x72\151\x63\x65"]; goto ktHhk; baNz3: $order["\x73\165\x72\x76\145\x79\137\157\162\x64\145\x72\x5f\151\144"] = intval($survey_order_id); goto dTbJw; gS989: iS0XU: goto Yxa7z; D9M7A: $order["\143\165\x73\x74\x6f\x6d\x65\x72\x5f\151\x64"] = $uid; goto hsub2; YAJTp: return $order; goto sGetv; a0ykj: JEjss: goto mOW4M; IjIgq: $order["\151\164\x65\155\137\x76\x65\x72\163\151\157\x6e"] = $subject["\x69\164\x65\x6d\137\x76\145\162\163\151\157\x6e"]; goto cz2AZ; KOzm7: Db::table("\x73\165\x62\152\x65\x63\x74")->where(["\x69\x64" => $subject_id])->setInc("\160\x61\x72\x74\151\143\x69\x70\x61\156\x74\163\137\163\x68\157\x77"); goto So9vT; Ym6et: Db::table("\143\165\163\164\x6f\x6d\145\162")->where(["\151\144" => $uid])->setInc("\x74\x6f\164\141\x6c\137\x74\x65\x73\164\137\161\165\x61\x6e\164\x69\x74\x79"); goto uSYtL; mOW4M: $subject = $this->getSubjectById($subject_id); goto LgBZN; P50um: if (!empty($res)) { goto Vnoyk; } goto s_RfB; K1K1q: Vnoyk: goto ktYEu; LgBZN: if (!empty($subject)) { goto Da0N0; } goto l7KoU; CcQ0a: tujHS: goto JuGQ_; RcUbs: $res = Db::table("\163\165\x62\x6a\145\x63\x74\x5f\157\x72\x64\145\162")->insert($order); goto P50um; lq2P0: if (!(empty($uid) || empty($subject_id))) { goto JEjss; } goto JJDJN; ktYEu: Db::table("\163\165\x62\x6a\x65\143\x74")->where(["\151\144" => $subject_id])->setInc("\x70\x61\162\x74\151\143\x69\x70\x61\x6e\164\163"); goto KOzm7; iv2x7: $order["\157\x72\144\145\162\x5f\x61\x6d\157\x75\x6e\x74"] = $orderAmount; goto c2d9T; YOI9C: exception("\xe6\xb5\213\xe8\xaf\x84\351\207\x8f\350\xa1\250\xe5\214\205\345\220\xab\347\232\204\351\xa2\230\347\x9b\xae\344\270\xba\347\251\272"); goto CcQ0a; TWZtY: $orderAmount = 0; goto zB2js; uWo_q: if (!($subject["\151\164\145\x6d\163"] == 0)) { goto tujHS; } goto YOI9C; l7KoU: exception("\346\xb5\213\350\257\204\xe4\xb8\215\345\255\x98\345\234\xa8"); goto ikOg0; So9vT: Db::table("\163\165\142\152\x65\143\x74")->where(["\151\x64" => $subject_id])->setInc("\164\x6f\x74\x61\154\x5f\141\155\157\165\x6e\x74", $order["\157\162\x64\145\162\x5f\141\x6d\x6f\x75\x6e\x74"]); goto Ym6et; mHvkc: $order["\143\x68\141\x6e\156\145\154\137\151\x64"] = intval($channel); goto XN7M2; dTbJw: $order["\x74\157\x74\141\x6c\137\151\164\145\155\163"] = $subject["\151\x74\x65\x6d\163"]; goto iv2x7; XN7M2: $order["\143\142\137\x6f\x72\144\145\162\x5f\x69\144"] = intval($cb_order_id); goto baNz3; c2d9T: $order["\160\141\x79\x5f\163\164\x61\x74\x75\x73"] = $order["\157\162\144\x65\162\137\x61\x6d\x6f\165\x6e\164"] > 0 ? Defs::PAY_WAIT : Defs::PAY_SUCCESS; goto IjIgq; cbkUo: if (!empty($survey)) { goto oLD1T; } goto hFq8d; A9eFX: Db::table("\143\x75\x73\x74\x6f\155\145\162")->where(["\151\144" => $uid])->setField("\x6c\x61\164\x65\163\164\x5f\x74\x65\x73\x74\x5f\164\151\x6d\x65", Db::raw("\156\x6f\167\x28\x29")); goto YAJTp; JJDJN: exception("\345\x8f\x82\xe6\x95\xb0\351\x94\231\xe8\xaf\xaf"); goto a0ykj; Yxa7z: $order = []; goto sZqTP; r6rP1: oLD1T: goto rY6Gx; s_RfB: exception("\346\225\260\xe6\215\256\xe5\272\x93\xe6\226\260\345\242\x9e\350\256\242\345\x8d\225\345\xbc\202\xe5\xb8\xb8"); goto K1K1q; hFq8d: exception("\346\231\256\xe6\237\xa5\xe6\265\x8b\350\257\x95\350\256\242\345\x8d\x95\344\xb8\215\xe5\255\230\345\x9c\xa8"); goto r6rP1; rY6Gx: if (!intval($survey["\x63\x66\147\137\146\162\145\145"])) { goto bT7Yw; } goto TWZtY; hsub2: $order["\163\165\142\152\x65\x63\164\137\x69\x64"] = $subject_id; goto mHvkc; zB2js: bT7Yw: goto gS989; ktHhk: if (!$survey_order_id) { goto iS0XU; } goto U8fw7; U8fw7: $survey = Db::table("\163\x75\162\x76\145\x79\137\x6f\162\x64\x65\x72")->alias("\x4f")->join("\163\165\162\166\145\x79\x20\123", "\x4f\56\163\165\162\166\x65\x79\x5f\151\144\75\x53\x2e\151\144")->where("\x4f\x2e\151\x64", $survey_order_id)->field("\x53\56\52")->find(); goto cbkUo; uSYtL: Db::table("\143\165\163\x74\157\x6d\x65\x72")->where(["\x69\x64" => $uid])->setInc("\x74\157\164\x61\x6c\x5f\164\x65\x73\x74\137\x61\155\157\x75\156\x74", $order["\x6f\162\144\x65\x72\137\141\x6d\x6f\x75\156\x74"]); goto A9eFX; cz2AZ: $order["\x71\165\145\x73\164\x69\157\x6e\137\x66\x6f\x72\x6d"] = $subject["\161\165\145\x73\164\x69\x6f\156\x5f\146\157\162\x6d"]; goto RcUbs; sGetv: } public function regenerateOrder($order_no) { goto mBI5c; gtVdF: $order["\161\165\145\x73\164\151\157\156\137\141\x6e\163\167\145\162"] = ''; goto o3jZl; dFbOn: exception("\xe6\227\240\xe6\263\225\xe6\211\xbe\345\210\xb0\xe8\xaf\xa5\xe8\xae\242\xe5\x8d\x95"); goto giSiE; IY30P: $order = []; goto oPTJE; Ka9gt: $subject_id = $order["\x73\x75\142\152\145\143\164\x5f\151\x64"]; goto wO_52; giSiE: UbewS: goto Ka9gt; dd5Df: exception("\346\xb5\x8b\350\257\204\344\xb8\215\xe5\255\230\345\x9c\xa8"); goto EZTCu; YngDv: $order["\161\x75\x65\163\164\151\157\x6e\137\146\x6f\162\155"] = $subject["\x71\165\145\x73\x74\151\x6f\156\x5f\146\157\x72\155"]; goto gtVdF; wO_52: $subject = $this->getSubjectById($subject_id); goto cdGaL; EZTCu: g11bz: goto IY30P; ISvih: $order["\162\x65\x73\x75\154\164"] = null; goto Fmr_g; XnSPx: $order["\164\145\x73\x74\137\x69\x74\x65\x6d\x73"] = 0; goto YMjsI; YMjsI: $order["\x63\165\x72\x72\137\151\x74\x65\x6d"] = 0; goto g_MvI; Fmr_g: $order["\x66\151\x6e\x69\163\150\x65\x64"] = 0; goto YngDv; oPTJE: $order["\164\157\164\x61\x6c\x5f\151\164\145\x6d\x73"] = $subject["\x69\x74\x65\155\163"]; goto XnSPx; BZyJY: if ($order) { goto UbewS; } goto dFbOn; o3jZl: $order["\x69\164\145\x6d\137\x76\145\162\163\151\x6f\x6e"] = $subject["\x69\x74\145\155\x5f\166\145\x72\163\x69\x6f\156"]; goto wi4KY; mBI5c: $order = $this->getOrderByNo($order_no); goto BZyJY; wi4KY: Db::table("\x73\x75\142\x6a\x65\x63\x74\137\x6f\x72\144\145\162")->where("\x6f\x72\144\145\162\x5f\156\x6f", $order_no)->update($order); goto aMuYm; cdGaL: if (!empty($subject)) { goto g11bz; } goto dd5Df; g_MvI: $order["\x69\164\x65\x6d\x73"] = ''; goto ISvih; aMuYm: } public function refreshOrderNo($customerId, $orderNo) { goto RKbFX; MMMpT: $orderNoNew = generateSequenceNo($customerId, Defs::SUBJECT_ORDER_NO_SEQ_NUM_KEY, "\x53"); goto eDKVj; q8YVk: return $orderNoNew; goto eG9kh; VBoHt: if ($infos) { goto esYN7; } goto eeJF2; l42nI: esYN7: goto MMMpT; eDKVj: Db::table("\163\x75\142\152\145\143\x74\x5f\157\162\144\145\162")->where(["\143\165\x73\x74\157\x6d\145\x72\137\x69\144" => $customerId, "\x6f\162\x64\x65\162\137\156\x6f" => $orderNo])->setField("\x6f\162\x64\x65\x72\137\156\157", $orderNoNew); goto q8YVk; eeJF2: return false; goto l42nI; RKbFX: $infos = Db::table("\163\x75\142\152\x65\x63\x74\137\157\162\144\x65\x72")->where(["\143\x75\163\x74\157\x6d\x65\162\137\x69\144" => $customerId, "\157\162\x64\x65\162\137\156\x6f" => $orderNo])->find(); goto VBoHt; eG9kh: } public function refreshOrderNoById($customerId, $id) { goto eTtFI; N_W4o: Db::table("\x73\165\142\152\145\143\164\x5f\157\162\144\145\162")->where(["\151\144" => $id])->setField("\157\162\x64\145\162\x5f\x6e\x6f", $orderNoNew); goto CC541; CC541: return $orderNoNew; goto uqLmR; eTtFI: $infos = Db::table("\x73\x75\142\152\x65\x63\164\x5f\x6f\x72\x64\x65\x72")->where(["\x69\x64" => $id])->find(); goto irPBf; irPBf: if ($infos) { goto d3vBL; } goto Ob1JM; dCii4: $orderNoNew = generateSequenceNo($customerId, Defs::SUBJECT_ORDER_NO_SEQ_NUM_KEY, "\x53"); goto N_W4o; Ob1JM: return false; goto JVGk0; JVGk0: d3vBL: goto dCii4; uqLmR: } public function paySuccessOrder($order_no) { goto cE3Et; cE3Et: $order = $this->getOrderByNo($order_no); goto r0cmI; reQd0: fqm43: goto ha46e; ha46e: Db::table("\x73\165\142\152\x65\143\164\x5f\157\162\x64\145\x72")->where(["\x6f\162\144\145\x72\137\156\x6f" => $order_no])->update(["\156\157\x74\151\146\171\137\x74\x69\x6d\145" => date("\131\x2d\x6d\x2d\x64\40\110\x3a\151\72\163"), "\160\x61\x79\137\x73\x74\x61\x74\165\x73" => Defs::PAY_SUCCESS]); goto N_KcA; r0cmI: if (!empty($order)) { goto fqm43; } goto sq2cD; sq2cD: exception("\xe8\256\xa2\345\x8d\225\xe4\270\215\xe5\255\230\345\234\250\xef\xbc\232" . $order_no); goto reQd0; N_KcA: } public function getSubjectItems($subject_id) { goto WC92B; NsL7a: return []; goto uXqHQ; uXqHQ: cPdo3: goto Z5qKu; WC92B: $rows = Db::table("\x73\x75\x62\x6a\x65\143\164\137\151\164\145\x6d")->where(["\163\165\x62\152\145\143\164\137\151\144" => $subject_id])->field(true)->order("\163\x6f\162\x74\40\141\163\143\x2c\40\x69\144\40\x61\163\143")->select(); goto riBD4; riBD4: if (!empty($rows)) { goto cPdo3; } goto NsL7a; Hu1Xt: oe26U: goto x9WHJ; x9WHJ: return $items; goto kmrFZ; Z5qKu: $items = []; goto qDRvM; qDRvM: foreach ($rows as $k => $v) { goto p_jBL; ukiZA: if (!($k < count($rows) - 1)) { goto sdQnG; } goto bNm34; aQf2P: if (empty($v["\x6f\160\164\x69\x6f\156\137" . $i])) { goto Hng2o; } goto x81t2; CbIL5: $v["\156\145\170\164\137\151\x64"] = intval($nextId); goto NDETw; jgOul: $v["\x70\x72\x65\x76\137\151\144"] = intval($prevId); goto CbIL5; DQsKd: $prevId = $rows[$k - 1]["\x69\144"]; goto NJ8Dn; p_jBL: $prevId = 0; goto nPqYw; nLVFR: $nextId = 0; goto ukiZA; bLsfH: $i = 1; goto Cx52T; LDAwm: sdQnG: goto jgOul; awyvR: $i++; goto F_BF7; NDETw: $v["\151\164\x65\155"] = nl2br($v["\x69\164\x65\x6d"]); goto bLsfH; klJRa: VFNLw: goto ZyQdk; YM_FW: if (!($i <= 12)) { goto BDtjH; } goto aQf2P; Cx52T: NsIXW: goto YM_FW; t_6lr: Hng2o: goto awyvR; X3sgY: BDtjH: goto xuhTX; x81t2: $v["\x6f\x70\164\151\x6f\x6e\137" . $i] = nl2br($v["\x6f\x70\x74\151\x6f\156\137" . $i]); goto t_6lr; bNm34: $nextId = $rows[$k + 1]["\151\144"]; goto LDAwm; nPqYw: if (!($k > 0)) { goto L9_Ix; } goto DQsKd; NJ8Dn: L9_Ix: goto nLVFR; xuhTX: $items[$v["\x69\x64"]] = $v; goto klJRa; F_BF7: goto NsIXW; goto X3sgY; ZyQdk: } goto Hu1Xt; kmrFZ: } public function getSubjectItem($item_id) { goto Yfap_; k8POd: GLGe5: goto LCa3I; nZ46G: if (!($targetKey > 0)) { goto GLGe5; } goto uDGkQ; dAMgR: $row["\160\162\x65\x76\137\151\144"] = 0; goto FiCDz; FTP1X: if (!$row) { goto BNXsS; } goto RFC6A; LCa3I: if (!($targetKey < count($itemIds) - 1)) { goto bXVA6; } goto Bx2GA; lhgCa: BNXsS: goto X_CZ0; xP7ND: $targetKey = array_search($item_id, $itemIds); goto lONLy; YHlJD: I1dBE: goto lhgCa; RFC6A: $itemIds = Db::table("\x73\165\x62\x6a\x65\143\x74\x5f\x69\x74\x65\x6d")->where(["\x73\165\142\152\145\x63\x74\137\x69\144" => $row["\x73\x75\x62\x6a\x65\x63\164\137\151\144"]])->order("\163\x6f\162\164\40\141\x73\x63\54\x20\x69\144\x20\141\163\x63")->column("\x69\x64"); goto dAMgR; X_CZ0: return $row; goto oLduP; FiCDz: $row["\x6e\x65\170\164\137\151\144"] = 0; goto xP7ND; lONLy: if (!($targetKey !== false)) { goto I1dBE; } goto nZ46G; Yfap_: $row = Db::table("\163\165\142\x6a\145\143\x74\x5f\x69\x74\145\155")->where(["\151\144" => $item_id])->field(true)->find(); goto FTP1X; uDGkQ: $row["\x70\162\x65\166\137\x69\x64"] = $itemIds[$targetKey - 1]; goto k8POd; Bx2GA: $row["\x6e\145\x78\x74\137\x69\x64"] = $itemIds[$targetKey + 1]; goto bee7M; bee7M: bXVA6: goto YHlJD; oLduP: } public function answerItem($order_no, $item_id, $item_type, $item_option) { goto wWwAi; tqyWg: $order = $this->getOrderByNo($order_no); goto TWKr3; bYFpH: $update["\164\x65\163\x74\137\x69\x74\x65\x6d\163"] = 1; goto ElDea; N152n: if (!$order["\x66\x69\x6e\x69\163\x68\x65\144"]) { goto uSvZH; } goto xVoHR; mTq8H: if (!empty($item["\x6e\145\x78\x74\x5f\x69\144"])) { goto k7qAi; } goto W8PpO; gkzXd: d2YWk: goto Iw7Dn; mH5CU: $subject = $this->getSubjectById($order["\x73\x75\142\x6a\x65\x63\164\137\x69\x64"]); goto Pml7_; JuhQN: foreach ($itemExists as $itemExist) { goto OGRz8; FKVNO: $answer[$itemIdExist] = $itemExist; goto DoZEy; DoZEy: HPxfL: goto P3GRs; Q59OZ: goto z9_qe; goto uMcJ0; OGRz8: $itemIdExist = explode("\46", $itemExist)[0]; goto gzr0V; gzr0V: if (!($itemIdExist == $item_id)) { goto dFPtU; } goto Q59OZ; uMcJ0: dFPtU: goto FKVNO; P3GRs: } goto o_tWn; wWwAi: if (!(empty($order_no) || empty($item_id) || empty($item_type))) { goto i_nRZ; } goto y_c02; sx6j9: $item_option = []; goto kT6Qb; gc7F9: $update["\x74\145\163\164\137\x69\x74\145\x6d\x73"] = count($answer) + 1; goto rcyUq; Lk5d_: $update["\x63\165\162\x72\x5f\151\164\145\155"] = $item_id; goto Kjg2z; a2Lek: exception("\xe6\xb5\x8b\350\xaf\204\xe9\241\xb9\347\233\xae\347\211\210\346\234\254\xe5\217\221\347\x94\237\xe4\xba\206\345\x8f\230\xe6\x9b\264\xef\xbc\x8c\351\x9c\x80\xe8\246\201\xe9\x87\215\xe6\226\260\xe6\265\213\xe8\xaf\204", -1); goto HWjqh; wKWe1: $update["\x72\x65\x73\165\x6c\x74"] = json_encode(["\x72\x65\x70\x6f\x72\x74\x4c\151\x73\x74" => $result], JSON_UNESCAPED_UNICODE); goto PP7Xi; xCKQK: $update["\167\141\x72\x6e\151\x6e\147\x5f\154\145\166\x65\x6c"] = Defs::MEASURE_WARNING_UNKOWN_LEVEL; goto JUYMb; kkUwq: $order["\164\145\163\164\137\x61\154\x6c\x6f\x77\137\166\151\x65\167\137\162\x65\x70\x6f\162\x74"] = $subject["\164\145\163\x74\137\x61\154\x6c\157\167\x5f\x76\x69\145\x77\137\162\x65\x70\157\162\x74"]; goto S_Uhx; HMq6K: if (!empty($item_option)) { goto jURfT; } goto sx6j9; HWjqh: RrZct: goto TDy9E; kYXNb: cO0xy: goto H6iyW; fcX1T: $update["\x66\x69\x6e\151\x73\x68\x5f\x74\151\155\145"] = date("\x59\55\x6d\x2d\144\40\110\x3a\151\72\x73"); goto tRmkj; o_tWn: z9_qe: goto gc7F9; H6iyW: if (!($order["\x69\164\145\x6d\137\166\145\162\x73\151\157\x6e"] != $subject["\151\164\145\155\x5f\166\x65\x72\x73\x69\157\156"])) { goto RrZct; } goto a2Lek; UWKIv: d7idh: goto N152n; zl9XG: $item_option = str_replace("\54", "\73", $item_option); goto MOy22; dlnDF: uSvZH: goto mH5CU; CwL0Z: $this->updateCombinationOrderStatus($order["\143\x62\x5f\157\x72\144\145\162\137\x69\x64"], $order["\x73\x75\x62\x6a\145\x63\164\x5f\x69\x64"]); goto TkMNg; L2mnt: $answer[$item_id] = $item_id . "\46" . $item_type . "\46" . $item_option; goto pnT_A; N27tH: i_nRZ: goto tqyWg; TkMNg: RfFJ6: goto c1WoH; xVoHR: exception("\346\xb5\213\xe8\257\204\345\267\262\345\256\214\346\x88\220"); goto dlnDF; Pml7_: if (!empty($subject)) { goto cO0xy; } goto Zg82l; pnT_A: $update["\x69\x74\x65\155\163"] = join("\x2c", $answer); goto mTq8H; AYUvH: exception("\xe8\257\x84\346\265\213\xe9\242\x98\xe7\x9b\xae\xe4\270\x8d\xe5\xad\230\345\234\250\xef\xbc\x9a" . $item_id); goto gkzXd; s0RmP: $item_option = htmlspecialchars_decode($item_option); goto zl9XG; Iw7Dn: $update = []; goto Lk5d_; c1WoH: if (!$order["\163\165\162\x76\145\171\x5f\157\x72\144\x65\x72\x5f\x69\x64"]) { goto Yc8tu; } goto TjTrc; u0Muw: if (!empty($item)) { goto d2YWk; } goto AYUvH; WiANl: $item_option = htmlspecialchars($item_option); goto YMW_N; tRmkj: $result = SubjectLogic::I()->generateTestResult($order["\163\x75\x62\152\145\x63\x74\137\151\x64"], $this->parseOrderItems($update["\x69\x74\145\155\x73"])); goto xCKQK; JUYMb: array_walk($result, function ($item) use(&$update) { goto B032L; B032L: if (isset($item["\167\141\162\156\x69\156\147\x5f\154\x65\x76\x65\154"])) { goto dJC1i; } goto LrGav; KeHeM: dJC1i: goto lj7a2; y79Ht: $update["\167\141\162\x6e\151\x6e\x67\x5f\154\x65\x76\x65\x6c"] = $item["\167\x61\x72\156\x69\x6e\147\x5f\x6c\145\x76\145\154"]; goto pKNXE; pKNXE: xocw8: goto wy7Ra; lj7a2: if (!($item["\167\141\x72\156\151\156\x67\x5f\154\x65\166\x65\154"] > $update["\x77\x61\162\x6e\151\x6e\x67\x5f\154\145\166\145\x6c"])) { goto xocw8; } goto y79Ht; LrGav: return; goto KeHeM; wy7Ra: }); goto wKWe1; MOy22: $item_option = str_replace("\46", "\x20", $item_option); goto WiANl; xYpuA: $itemExists = explode("\54", $order["\151\164\x65\155\163"]); goto JuhQN; Kjg2z: $answer = []; goto EXVBQ; YMW_N: b_rIT: goto L2mnt; ElDea: NK49T: goto rbW2B; RjPVH: OauDS: goto bYFpH; PP7Xi: if (!$order["\x63\x62\137\x6f\162\144\145\x72\137\151\144"]) { goto RfFJ6; } goto CwL0Z; sugHL: $item_option = join("\55", $item_option); goto GzkiK; GzkiK: VyBd2: goto QrwEW; QrwEW: goto b_rIT; goto CyMP_; fgW35: if (!($item_type == Defs::QUESTION_CHECKBOX)) { goto VyBd2; } goto HMq6K; gz2aT: Db::table("\163\x75\142\x6a\145\x63\x74\x5f\x6f\x72\144\145\162")->where(["\157\162\x64\x65\x72\x5f\x6e\x6f" => $order_no])->update($update); goto kkUwq; TWKr3: if (!empty($order)) { goto d7idh; } goto Mq5sn; TDy9E: $item = $this->getSubjectItem($item_id); goto u0Muw; y_c02: exception("\xe7\274\272\345\xb0\x91\xe5\x8f\202\xe6\x95\xb0"); goto N27tH; Zg82l: exception("\350\xaf\204\xe6\265\213\xe9\207\217\xe8\xa1\xa8\344\270\215\xe5\255\230\xe5\x9c\250\xef\274\232" . $order_no); goto kYXNb; W8PpO: $update["\x66\151\156\x69\x73\x68\x65\144"] = 1; goto fcX1T; rbW2B: if ($item_type == Defs::QUESTION_TEXT) { goto alcPR; } goto fgW35; Mq5sn: exception("\xe8\xaf\204\xe6\xb5\x8b\350\256\xa2\xe5\x8d\225\344\xb8\x8d\xe5\xad\230\345\234\250\xef\274\x9a" . $order_no); goto UWKIv; S_Uhx: return array_merge($order, $update); goto Tt9uI; CyMP_: alcPR: goto s0RmP; EXVBQ: if ($order["\x74\x65\163\164\x5f\x69\164\x65\x6d\163"] == "\x30") { goto OauDS; } goto xYpuA; TjTrc: $this->updateSurveyOrderStatus($order["\x73\x75\x72\x76\x65\171\137\x6f\x72\x64\145\162\x5f\x69\144"], $order["\x73\165\142\152\145\x63\x74\x5f\151\144"]); goto ql3f0; rcyUq: goto NK49T; goto RjPVH; ql3f0: Yc8tu: goto tFcXF; kT6Qb: jURfT: goto sugHL; tFcXF: k7qAi: goto gz2aT; Tt9uI: } public function getSubjectStandards($subject_id) { $rows = Db::table("\163\x75\142\x6a\145\143\164\x5f\163\164\x61\x6e\144\x61\x72\x64")->where(["\163\165\x62\x6a\145\x63\x74\137\151\x64" => $subject_id])->field(true)->order("\163\x6f\x72\x74\x20\141\x73\x63\54\x20\x69\x64\40\x61\x73\x63")->select(); return $rows; } public function getStandardLatitude($subject_id) { goto xVIfZ; xVIfZ: $rows = Db::table("\x73\165\142\x6a\145\x63\164\137\x73\164\x61\x6e\x64\141\162\x64\x5f\154\141\164\151\164\x75\144\145")->where(["\x73\165\142\152\x65\x63\x74\x5f\x69\x64" => $subject_id])->field(true)->order("\151\144\40\x61\163\143")->select(); goto zq2E3; cTG2_: $rows = []; goto v8IuQ; Ivzw6: return $rows; goto u6Ysx; zq2E3: if (!empty($rows)) { goto Sl6DY; } goto cTG2_; v8IuQ: Sl6DY: goto Ivzw6; u6Ysx: } public function parseOrderItems($items) { goto Kx5kj; NIKLE: $parsed = []; goto DplD6; RcsGh: dvrzh: goto lpjA0; lpjA0: return $parsed; goto yJMx8; FOn5V: IIKZ8: goto NIKLE; Kmhh2: return []; goto FOn5V; Kx5kj: $items = explode("\54", $items); goto J353b; J353b: if (!empty($items)) { goto IIKZ8; } goto Kmhh2; DplD6: foreach ($items as $k => $v) { goto ENS93; f9S1g: if (empty($optionValue)) { goto xHsDf; } goto JFZb4; ENS93: $sections = explode("\46", $v); goto KQtuQ; VMUx5: if ($itemType == Defs::QUESTION_CHECKBOX) { goto PNXMa; } goto Z5iLy; BPiWD: goto DIUHj; goto WrVg1; KNTS5: SpVJX: goto oaQRq; tG31z: PNXMa: goto f9S1g; sN2tI: Xwmj2: goto ZGrAF; YefwR: goto BpLsw; goto KNTS5; hR0qZ: $parsed[$itemId] = ["\164\x79\x70\x65" => $itemType, "\166\141\154\165\145" => []]; goto iWZvw; BU32k: $itemType = $sections[1]; goto PvKNx; BXrdW: OTa2b: goto sEv0f; Z5iLy: $parsed[$itemId] = ["\164\171\160\145" => $itemType, "\166\x61\154\165\x65" => $optionValue]; goto KPFCc; sEv0f: if (!(empty($sections[0]) || empty($sections[1]) || empty($sections[2]))) { goto SpVJX; } goto YefwR; JFZb4: $parsed[$itemId] = ["\164\x79\x70\x65" => $itemType, "\166\141\x6c\165\x65" => explode("\55", $optionValue)]; goto BPiWD; oaQRq: $itemId = $sections[0]; goto BU32k; KPFCc: goto Xwmj2; goto tG31z; uFW6z: goto BpLsw; goto BXrdW; iWZvw: DIUHj: goto sN2tI; PvKNx: $optionValue = $sections[2]; goto VMUx5; KQtuQ: if (!(count($sections) != 3)) { goto OTa2b; } goto uFW6z; ZGrAF: BpLsw: goto XmK8j; WrVg1: xHsDf: goto hR0qZ; XmK8j: } goto RcsGh; yJMx8: } public function cleanSubject($subject_id) { goto ET8eC; VkSGm: Db::table("\163\x75\142\x6a\x65\143\x74\137\151\164\145\x6d")->where(["\163\x75\142\x6a\x65\143\164\137\x69\144" => $subject_id])->delete(); goto rDpmK; D_Bix: Db::table("\x73\165\x62\152\x65\143\164\137\163\164\141\156\144\141\162\144\137\154\x61\x74\151\164\x75\x64\145")->where(["\x73\x75\x62\152\145\143\164\137\151\x64" => $subject_id])->delete(); goto MMp4D; rDpmK: Db::table("\163\x75\x62\x6a\x65\x63\164\137\x69\x74\145\155\137\x73\164\141\156\x64\x61\162\x64")->where(["\x73\165\x62\x6a\x65\x63\x74\137\x69\144" => $subject_id])->delete(); goto d9VKx; ET8eC: Db::table("\x73\165\x62\x6a\x65\x63\x74")->where(["\151\144" => $subject_id])->delete(); goto VkSGm; d9VKx: Db::table("\x73\165\142\x6a\145\x63\x74\x5f\x73\164\141\156\144\x61\162\x64")->where(["\x73\x75\x62\x6a\145\143\164\x5f\x69\144" => $subject_id])->delete(); goto D_Bix; MMp4D: } public function getCombinationOrderInfo($order_id) { goto WY1qs; gTcUs: if (!empty($row)) { goto uj1fS; } goto Vs4uT; s6nI5: $row["\144\141\164\141"] = json_decode($row["\144\x61\x74\141"], true); goto asppC; nkBqp: w5P8L: goto KTcmV; Vs4uT: return false; goto I9jEh; asppC: $row["\156\x65\170\x74\137\x74\x65\x73\164\137\x69\x64"] = 0; goto sWs1U; I9jEh: uj1fS: goto s6nI5; WY1qs: $row = Db::table("\x63\157\155\142\151\156\141\x74\x69\x6f\156\x5f\157\162\x64\x65\x72")->where("\151\144", $order_id)->find(); goto gTcUs; sWs1U: if (!($row["\146\x69\x6e\151\x73\x68\145\144"] == 0)) { goto EDfrv; } goto M93cd; KTcmV: EDfrv: goto SC7_4; SC7_4: return $row; goto UgZUa; M93cd: foreach ($row["\144\141\x74\141"] as $sid => $finished) { goto T3hA6; oqGOs: PL_Dm: goto MOkFT; MOkFT: fXv7g: goto D3S8b; xSiel: $row["\x6e\x65\x78\x74\x5f\x74\145\163\164\x5f\151\144"] = $sid; goto J3JCV; J3JCV: goto w5P8L; goto oqGOs; T3hA6: if (!empty($finished)) { goto PL_Dm; } goto xSiel; D3S8b: } goto nkBqp; UgZUa: } public function getSurveyOrderInfo($order_id) { goto MkB1I; Jn_n8: buF0Q: goto TeMC_; fkSQ1: foreach ($row["\x64\141\164\x61"] as $sid => $finished) { goto T3hZz; LroVz: $row["\156\145\x78\x74\137\164\x65\x73\x74\137\x69\x64"] = $sid; goto mM8kH; ZSjew: YtzLm: goto ugRjd; mM8kH: goto uCbkT; goto ZSjew; T3hZz: if (!empty($finished)) { goto YtzLm; } goto LroVz; ugRjd: k6qQJ: goto mzQ3l; mzQ3l: } goto SITV3; PKlfg: sRLem: goto MPPV0; IN8hL: return false; goto PKlfg; TeMC_: return $row; goto Seb_R; sEWDI: $row["\156\145\x78\x74\x5f\x74\x65\163\164\137\151\x64"] = 0; goto LY2N0; MkB1I: $row = Db::table("\x73\165\x72\x76\x65\x79\x5f\x6f\162\144\x65\162")->where("\151\x64", $order_id)->find(); goto If0Z9; LY2N0: if (!($row["\x66\151\156\151\x73\150\145\144"] == 0)) { goto buF0Q; } goto fkSQ1; SITV3: uCbkT: goto Jn_n8; MPPV0: $row["\144\141\x74\x61"] = json_decode($row["\144\x61\x74\x61"], true); goto sEWDI; If0Z9: if (!empty($row)) { goto sRLem; } goto IN8hL; Seb_R: } public function updateCombinationOrderStatus($order_id, $subject_id) { goto Is8tB; gg3Yn: return true; goto xFoZm; gCaBE: if (!empty($ing)) { goto xjwqE; } goto GnMsT; LUt5D: $ing = array_filter($row["\144\141\164\141"], function ($finished) { return $finished == 0; }); goto gCaBE; Is8tB: $row = $this->getCombinationOrderInfo($order_id); goto I0RDO; CwVn4: xjwqE: goto qfSZ6; GnMsT: $row["\x66\151\156\151\x73\x68\145\144"] = 1; goto CwVn4; Pewvq: VAtKl: goto gxVDV; I0RDO: if (!empty($row)) { goto VAtKl; } goto UeiiV; UeiiV: return false; goto Pewvq; gxVDV: $row["\x64\141\164\141"][$subject_id] = 1; goto LUt5D; qfSZ6: Db::table("\x63\157\155\x62\x69\x6e\141\164\x69\157\156\137\x6f\162\x64\x65\162")->where("\151\144", $order_id)->update(["\144\141\x74\x61" => json_encode($row["\x64\x61\164\141"]), "\146\151\x6e\151\163\x68\145\x64" => $row["\146\151\x6e\x69\163\150\145\x64"]]); goto gg3Yn; xFoZm: } public function updateSurveyOrderStatus($order_id, $subject_id) { goto Na6Tc; MtdMb: D4xHd: goto lM8Rp; NAiTZ: return true; goto ovZKW; hBUfJ: $row["\146\x69\x6e\151\x73\150\145\x64"] = 1; goto MtdMb; Uf8y5: $ing = array_filter($row["\144\x61\164\141"], function ($finished) { return $finished == 0; }); goto gceGe; lM8Rp: Db::table("\x73\165\x72\166\145\171\137\157\x72\144\145\162")->where("\151\144", $order_id)->update(["\144\x61\164\x61" => json_encode($row["\x64\x61\164\141"]), "\146\x69\x6e\151\x73\150\x65\144" => $row["\x66\x69\x6e\x69\163\x68\145\144"]]); goto NAiTZ; WWoma: BU5fi: goto obeW2; vM5nA: if (!empty($row)) { goto BU5fi; } goto m3_6S; gceGe: if (!empty($ing)) { goto D4xHd; } goto hBUfJ; m3_6S: return false; goto WWoma; obeW2: $row["\144\141\164\141"][$subject_id] = 1; goto Uf8y5; Na6Tc: $row = $this->getSurveyOrderInfo($order_id); goto vM5nA; ovZKW: } }
