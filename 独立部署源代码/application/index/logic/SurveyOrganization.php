<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\Defs; use app\index\service\RequestContext; class SurveyOrganization extends Base { public function loadTreeDatas($surveyId) { goto DZyyW; YE2d2: $treeDatas[] = $this->loadTreeDataRecursively($surveyId, 0); goto xMtiG; xMtiG: return $treeDatas; goto joJOp; DZyyW: $treeDatas = []; goto YE2d2; joJOp: } protected function loadTreeDataRecursively($surveyId, $id = 0, $parentId = 0, $breadcrumbParent = '') { goto vZ4Zo; vZ4Zo: if ($id == 0) { goto Bidj1; } goto TIYAg; qPCT5: if (!($text === null)) { goto MFMOw; } goto RjC1e; RjC1e: return null; goto uZ5hZ; TIYAg: $text = Db::table("\163\x75\x72\x76\x65\171\137\x6f\162\x67\x61\x6e\151\172\x61\164\x69\x6f\156")->where(["\151\144" => $id])->value("\156\x61\x6d\x65"); goto qPCT5; zU5X3: IBCFJ: goto i8TtQ; KAd_2: $breadcrumb = empty($breadcrumbParent) ? $text : $breadcrumbParent . "\40\46\x67\164\x3b\x20" . $text; goto fIHnI; PhWrH: $treeNodeDatas = ["\x69\144" => $id, "\160\x61\162\145\x6e\x74\137\x69\x64" => $parentId, "\164\x65\x78\164" => $text, "\x69\x63\157\156\x43\154\163" => "\x69\143\x6f\156\163\x2d\x70\x6f\151\x6e\x74", "\x73\164\141\164\x65" => "\157\160\145\156", "\x63\150\151\154\144\x72\145\x6e" => [], "\142\x72\x65\141\x64\x63\162\x75\x6d\142" => $breadcrumb]; goto J3v2d; i8TtQ: $childOrganizations = Db::table("\163\165\x72\x76\145\x79\x5f\x6f\x72\147\x61\x6e\x69\x7a\x61\x74\151\157\156")->where(["\160\x61\x72\x65\156\164\137\x69\144" => $id, "\x73\165\x72\x76\x65\171\137\151\x64" => $surveyId])->field("\151\x64\x2c\x6e\141\155\x65\54\160\x61\162\145\x6e\164\x5f\151\144")->order("\x6f\x72\144\145\162\40\x61\163\x63\54\40\x69\x64\x20\x61\x73\x63")->select(); goto Y8oZZ; rpziR: $text = "\346\x99\256\xe6\x9f\245\347\xbb\204\347\273\x87"; goto KAd_2; Y8oZZ: foreach ($childOrganizations as $childOrganization) { goto CqZ9K; W14Z3: lIYib: goto cxkBr; jVIaj: wW12T: goto W14Z3; foDUu: if (!$childNodeDatas) { goto wW12T; } goto tbB2Y; tbB2Y: $treeNodeDatas["\143\150\x69\x6c\x64\x72\x65\x6e"][] = $childNodeDatas; goto jVIaj; CqZ9K: $childNodeDatas = $this->loadTreeDataRecursively($surveyId, $childOrganization["\x69\x64"], $id, $breadcrumb); goto foDUu; cxkBr: } goto xpy7b; KRwuH: return $treeNodeDatas; goto Ce2Zw; a12iB: Bidj1: goto rpziR; t_iLX: $breadcrumb = empty($breadcrumbParent) ? $text : $breadcrumbParent . "\x20\x26\x67\x74\73\x20" . $text; goto PhWrH; fIHnI: $treeNodeDatas = ["\151\144" => 0, "\x70\141\x72\x65\156\x74\x5f\151\x64" => 0, "\164\x65\170\164" => $text, "\151\x63\157\x6e\103\154\x73" => "\x66\141\40\146\x61\x2d\x63\151\x72\x63\x6c\145", "\163\x74\141\164\x65" => "\x6f\x70\145\156", "\x63\150\x69\154\x64\162\145\x6e" => [], "\x62\162\145\x61\x64\x63\162\x75\155\x62" => $breadcrumb]; goto zU5X3; J3v2d: goto IBCFJ; goto a12iB; uZ5hZ: MFMOw: goto t_iLX; xpy7b: mIRiK: goto KRwuH; Ce2Zw: } public function loadComboDatas($surveyId, $id = 0, $prefix = '', $datas = array()) { goto IO2E0; tULYh: foreach ($childOrganizations as $childOrganization) { $datas = $this->loadComboDatas($surveyId, $childOrganization["\151\144"], $nextPrefix, $datas); Jso_z: } goto aWl1H; B81m0: $text = Db::table("\x73\x75\x72\166\145\x79\137\x6f\x72\x67\x61\x6e\x69\x7a\x61\x74\151\157\156")->where(["\151\x64" => $id])->value("\156\141\x6d\145"); goto Sjn8v; SKmRW: $childOrganizations = Db::table("\163\x75\x72\166\145\171\137\x6f\x72\x67\x61\x6e\x69\x7a\141\164\x69\x6f\156")->where(["\160\141\162\145\x6e\164\x5f\x69\144" => $id, "\163\x75\x72\x76\x65\171\137\x69\x64" => $surveyId])->field("\x69\144\54\156\x61\155\145\54\x70\141\x72\145\156\164\137\151\144")->order("\x6f\162\x64\145\162\x20\141\163\x63\54\x20\x69\x64\40\x61\163\x63")->select(); goto tULYh; PxOgA: $datas[$id] = "\55\xe8\257\xb7\xe9\x80\211\346\213\xa9\x2d"; goto B0Vde; IO2E0: if ($id == 0) { goto P2CLZ; } goto B81m0; lcJM5: goto z5lAp; goto Biqom; MFbgB: $nextPrefix = $prefix . $text; goto lcJM5; Biqom: P2CLZ: goto PxOgA; TSA8z: return $datas; goto uepjI; aWl1H: tpQHR: goto TSA8z; U4jMG: $prefix .= "\x3e"; goto dKBSu; Sjn8v: if (!$prefix) { goto kNwlo; } goto U4jMG; dKBSu: kNwlo: goto FWo4F; FWo4F: $datas[$id] = $prefix . $text; goto MFbgB; B0Vde: $nextPrefix = ''; goto zQ7s2; zQ7s2: z5lAp: goto SKmRW; uepjI: } public function loadComboDatasLeaf($surveyId, $id = 0, $prefix = '', $datas = array()) { goto VAdZr; jG5j5: $childOrganizations = Db::table("\x73\165\162\x76\145\x79\x5f\x6f\x72\147\x61\x6e\151\172\141\164\x69\157\x6e")->where(["\160\141\x72\145\156\x74\x5f\x69\144" => $id, "\x73\165\x72\x76\x65\x79\137\151\x64" => $surveyId])->field("\x69\x64\x2c\x6e\141\155\145\x2c\x70\x61\162\x65\x6e\164\137\151\x64")->order("\157\162\144\x65\x72\40\x61\x73\x63\x2c\x20\x69\144\40\141\163\x63")->select(); goto Nj2XA; f6OI0: $nextPrefix = $prefix . $text; goto BYYy8; Nj2XA: foreach ($childOrganizations as $childOrganization) { $datas = $this->loadComboDatasLeaf($surveyId, $childOrganization["\x69\144"], $nextPrefix, $datas); OEQRy: } goto HCmNW; DtmND: if (!$prefix) { goto r5MJU; } goto cGjTG; RP_QL: $text = Db::table("\163\165\162\x76\x65\x79\x5f\x6f\162\147\141\x6e\x69\x7a\141\x74\151\x6f\156")->where(["\151\x64" => $id])->value("\156\x61\x6d\x65"); goto DtmND; wQ3AG: $datas[$id] = "\x2d\350\xaf\xb7\351\x80\x89\xe6\213\251\x2d"; goto smJlo; Fxggi: qi7ks: goto wQ3AG; smJlo: $nextPrefix = ''; goto zctBs; zctBs: krg0i: goto jG5j5; cGjTG: $prefix .= "\x3e"; goto C3yIF; C3yIF: r5MJU: goto BmszR; VAdZr: if ($id == 0) { goto qi7ks; } goto RP_QL; HCmNW: ZfM2s: goto wem9O; XAUhQ: if (!($childCount == 0)) { goto xZh9W; } goto IeM98; HNjZu: xZh9W: goto f6OI0; BmszR: $childCount = Db::table("\x73\165\162\x76\145\171\x5f\157\x72\x67\x61\156\151\x7a\x61\x74\x69\157\156")->where(["\x70\141\x72\145\156\x74\x5f\x69\144" => $id, "\x73\x75\x72\x76\x65\x79\x5f\151\144" => $surveyId])->count(); goto XAUhQ; IeM98: $datas[$id] = $prefix . $text; goto HNjZu; wem9O: return $datas; goto w2OmZ; BYYy8: goto krg0i; goto Fxggi; w2OmZ: } public function loadFullText($id, $suffix = '') { goto GajKq; RvMFq: $organization = Db::table("\163\165\162\166\145\x79\137\157\162\x67\141\156\151\172\x61\164\x69\x6f\x6e")->where(["\x69\144" => $id])->field("\x6e\141\155\x65\x2c\x20\x70\141\x72\145\x6e\x74\137\151\144")->find(); goto Txpcg; DosKV: p7DCJ: goto QOrer; wrOfD: PxfW1: goto RvMFq; BxtAo: if (!$suffix) { goto PCUn4; } goto Ue7d4; Ue7d4: $fullText .= "\x20\x26\x67\164\73\40" . $suffix; goto WqaHc; m1zOk: return $suffix; goto wrOfD; Txpcg: if (!empty($organization)) { goto p7DCJ; } goto LgQp4; LgQp4: return $suffix; goto DosKV; GajKq: if (!($id == 0)) { goto PxfW1; } goto m1zOk; WDkN1: return $fullText; goto wgo1w; WqaHc: PCUn4: goto cJtt_; QOrer: $fullText = $organization["\x6e\141\155\x65"]; goto BxtAo; cJtt_: $fullText = $this->loadFullText($organization["\x70\x61\162\x65\156\x74\x5f\x69\x64"], $fullText); goto WDkN1; wgo1w: } public function isEmpty($surveyId) { $count = Db::table("\x73\165\162\x76\145\x79\x5f\x6f\162\147\x61\156\x69\172\141\x74\151\x6f\156")->where(["\x70\141\162\x65\x6e\164\137\x69\x64" => 0, "\163\165\x72\x76\145\171\x5f\151\144" => $surveyId])->count(); return $count ? false : true; } public function add($surveyId, $name, $parentId) { goto ZvYZH; wjyjb: Db::table("\163\x75\162\166\145\171\x5f\x6f\162\147\141\156\x69\x7a\141\164\x69\157\x6e")->where(["\x69\x64" => $id])->setField("\x6f\x72\x64\x65\x72", $id); goto PG3Er; ZvYZH: $data = array("\163\165\162\x76\x65\171\x5f\x69\x64" => $surveyId, "\156\141\x6d\x65" => $name, "\x70\x61\162\145\x6e\164\137\x69\144" => $parentId); goto nTEey; PG3Er: return true; goto dGel2; nTEey: $id = Db::table("\163\x75\162\x76\145\171\137\x6f\x72\147\141\156\151\x7a\x61\164\x69\x6f\156")->insertGetId($data); goto wjyjb; dGel2: } public function update($id, $name) { goto ttYVM; JqnVK: Db::table("\163\x75\x72\x76\x65\171\137\157\162\x67\x61\156\151\x7a\141\x74\x69\157\x6e")->where("\x69\144", $id)->update($data); goto LJIyK; ttYVM: $data = array("\156\141\x6d\145" => $name); goto JqnVK; LJIyK: return true; goto ZvRG2; ZvRG2: } public function delete($surveyId, $id) { goto rkY3y; lwEKM: $result = Db::table("\x73\165\x72\166\x65\171\x5f\157\162\147\x61\156\x69\172\141\x74\x69\x6f\156")->where("\x69\144", $id)->delete(); goto jHhcr; jHhcr: return $result != 1 ? false : true; goto fFw2O; hrKW5: foreach ($orders as $order) { goto ioqDp; ioqDp: $orderId = $order["\x69\144"]; goto gSQzx; Je8wr: oQnRx: goto oLF5F; MHD_o: h8SGU: goto cwCfX; gSQzx: $personalData = json_decode($order["\x70\145\x72\163\x6f\x6e\141\154\137\x64\x61\164\141"], true); goto fUO42; WGtil: $personalData["\157\162\x67\x61\x6e\151\x7a\x61\x74\x69\157\x6e"] = 0; goto MHD_o; cwCfX: Db::table("\163\x75\x72\x76\x65\x79\x5f\157\162\144\145\162")->where("\151\x64", $orderId)->setField("\x70\145\162\x73\157\156\x61\154\137\x64\x61\164\141", json_encode($personalData)); goto Je8wr; fUO42: if (!isset($personalData["\x6f\x72\x67\141\x6e\151\x7a\x61\164\151\x6f\x6e"])) { goto h8SGU; } goto WGtil; oLF5F: } goto xBpQ7; xBpQ7: YErSd: goto f9aAC; rkY3y: $orders = Db::table("\163\x75\x72\166\x65\x79\x5f\157\162\144\145\x72")->where(["\x73\x75\162\x76\x65\171\x5f\151\144" => $surveyId, "\163\165\162\x76\145\171\x5f\157\x72\147\x61\156\151\x7a\x61\164\x69\x6f\156\137\151\144" => $id])->field("\x69\x64\54\x20\160\x65\162\x73\x6f\156\141\x6c\137\x64\141\x74\x61")->select(); goto hrKW5; f9aAC: Db::table("\x73\x75\162\166\145\x79\137\157\x72\x64\145\162")->where(["\163\x75\x72\166\145\x79\x5f\151\x64" => $surveyId, "\163\165\162\166\145\x79\137\157\162\147\141\x6e\x69\x7a\x61\x74\x69\157\156\x5f\x69\x64" => $id])->setField("\163\165\x72\166\x65\x79\x5f\157\x72\x67\141\156\151\172\141\164\151\x6f\156\x5f\x69\144", 0); goto lwEKM; fFw2O: } public function up($id) { goto I_kRo; mWKdm: if ($i < count($siblingOrganizations)) { goto EMmwe; } goto LDrxx; I_kRo: $parentId = Db::table("\x73\x75\x72\166\x65\x79\x5f\157\162\x67\141\156\151\172\x61\164\x69\157\156")->where(["\151\144" => $id])->value("\x70\141\162\145\x6e\x74\137\151\144"); goto Lh6lS; Br1bu: if (!empty($siblingOrganizations)) { goto h4uvw; } goto fjItA; StWaE: kLs4r: goto krRF8; VpJa3: if (!(count($siblingOrganizations) <= 1)) { goto kLs4r; } goto m0cAC; LDrxx: cfRoJ: goto wdynD; bF3i9: $order = $siblingOrganizations[$i]["\x6f\162\144\x65\x72"]; goto XvbfT; ArkE3: goto cfRoJ; goto icELR; pfLno: if (!($i == 0)) { goto D_owz; } goto ArkE3; icELR: D_owz: goto bF3i9; XvbfT: $orderPre = $siblingOrganizations[$i - 1]["\x6f\x72\x64\145\162"]; goto HMYSP; z2J5P: Db::table("\x73\165\x72\x76\145\x79\137\x6f\162\x67\x61\156\151\x7a\x61\x74\x69\157\x6e")->where(["\x69\144" => $siblingOrganizations[$i - 1]["\x69\x64"]])->setField("\157\162\144\x65\162", $order); goto kJS1x; Ps9Ha: h4uvw: goto VpJa3; Lh6lS: $siblingOrganizations = Db::table("\163\x75\x72\x76\145\x79\x5f\157\162\147\x61\x6e\151\172\x61\x74\151\157\156")->where(["\x70\141\x72\145\x6e\x74\x5f\151\x64" => $parentId])->field("\x69\144\x2c\156\x61\155\145\x2c\x70\x61\162\x65\x6e\164\x5f\x69\x64\54\x6f\x72\144\x65\x72")->order("\157\x72\x64\145\162\40\141\x73\x63\54\x20\151\x64\x20\141\x73\x63")->select(); goto Br1bu; wykps: $i++; goto mWKdm; HMYSP: Db::table("\x73\x75\162\166\145\171\x5f\157\162\x67\x61\156\151\x7a\141\x74\151\x6f\x6e")->where(["\x69\x64" => $id])->setField("\x6f\162\x64\145\x72", $orderPre); goto z2J5P; usfyk: EMmwe: goto RdaTH; m0cAC: return; goto StWaE; fjItA: return; goto Ps9Ha; krRF8: $i = 0; goto usfyk; kJS1x: R4pYV: goto wykps; RdaTH: if (!($siblingOrganizations[$i]["\x69\144"] == $id)) { goto R4pYV; } goto pfLno; wdynD: } public function down($id) { goto kCynI; ZSrGJ: $orderNext = $siblingOrganizations[$i + 1]["\157\162\144\x65\162"]; goto j7fUI; jeTCU: goto ExFXD; goto rUS0E; bvv7v: $i++; goto Lb5Gl; AtzVA: if (!($siblingOrganizations[$i]["\151\x64"] == $id)) { goto YA7Bo; } goto qDNCc; Bh5VU: hGq_K: goto dzSIY; c9idA: return; goto Bh5VU; yP5ia: return; goto Bukuj; rUS0E: mlYRN: goto D5Y9L; Bukuj: hSzlS: goto Mwpij; E6kKC: YA7Bo: goto bvv7v; qDNCc: if (!($i == count($siblingOrganizations) - 1)) { goto mlYRN; } goto jeTCU; sUoiD: $siblingOrganizations = Db::table("\163\165\x72\x76\x65\x79\137\157\162\x67\x61\156\151\x7a\x61\x74\151\x6f\x6e")->where(["\x70\141\x72\145\156\x74\137\151\x64" => $parentId])->field("\x69\x64\x2c\156\141\155\x65\x2c\160\141\x72\x65\156\x74\137\151\144\54\x6f\x72\144\145\x72")->order("\x6f\x72\144\145\x72\x20\x61\x73\x63\54\40\151\144\40\x61\163\143")->select(); goto mKl7w; QYnzd: Db::table("\x73\x75\x72\166\145\171\x5f\x6f\x72\x67\x61\x6e\x69\x7a\141\164\x69\157\156")->where(["\151\144" => $siblingOrganizations[$i + 1]["\151\x64"]])->setField("\x6f\x72\x64\x65\x72", $order); goto E6kKC; keKMy: ExFXD: goto qHjQm; Mwpij: $i = 0; goto MkrjO; j7fUI: Db::table("\x73\165\162\166\x65\171\x5f\x6f\162\x67\141\156\x69\172\x61\164\151\157\x6e")->where(["\151\144" => $id])->setField("\x6f\162\144\145\162", $orderNext); goto QYnzd; D5Y9L: $order = $siblingOrganizations[$i]["\157\162\x64\x65\162"]; goto ZSrGJ; MkrjO: r62z5: goto AtzVA; Lb5Gl: if ($i < count($siblingOrganizations)) { goto r62z5; } goto keKMy; mKl7w: if (!empty($siblingOrganizations)) { goto hGq_K; } goto c9idA; dzSIY: if (!(count($siblingOrganizations) <= 1)) { goto hSzlS; } goto yP5ia; kCynI: $parentId = Db::table("\x73\x75\162\x76\x65\x79\137\x6f\x72\x67\141\156\x69\172\x61\x74\151\157\156")->where(["\151\x64" => $id])->value("\x70\x61\162\x65\x6e\x74\x5f\151\x64"); goto sUoiD; qHjQm: } public function changeLevel($id, $parentId) { Db::table("\x73\x75\x72\x76\x65\x79\x5f\157\162\147\x61\156\151\x7a\141\164\151\157\156")->where("\151\x64", $id)->setField("\x70\x61\x72\x65\x6e\164\137\x69\144", $parentId); return true; } }
