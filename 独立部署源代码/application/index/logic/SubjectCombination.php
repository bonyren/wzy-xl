<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\Defs; use app\index\logic\Defs as IndexDefs; use app\index\service\RequestContext; use app\index\model\Survey as SurveyModel; use app\index\service\OperationLogs; class SubjectCombination extends Base { public function __construct() { } public function loadSubjectCombination($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto IQ1pA; hwBPn: $count = Db::table("\163\165\x62\152\x65\143\164\137\143\157\x6d\142\151\x6e\141\164\x69\157\156")->where($where)->count(); goto Ra9zf; OZCtJ: $where["\156\x61\155\145"] = ["\154\151\x6b\x65", "\45{$search["\x6e\x61\155\x65"]}\x25"]; goto hsFRa; j0rSr: Dp0v_: goto w2B9P; FTxBm: $order = "\163\164\141\x74\165\x73\40{$order}"; goto XTURL; kPYZu: if (!empty($subjectPairs)) { goto RVGE0; } goto lQw73; zw7W1: RVGE0: goto CdZx8; K6kA9: foreach ($rows as &$row) { goto xV5pY; J1_ek: $row["\x62\x61\x6e\x6e\x65\162"] = generateThumbnailUrl($row["\x62\x61\156\x6e\145\x72"], 100); goto YKQ2o; NuOAv: oL170: goto YBsUr; IwLFA: R76PA: goto pYhxD; YKQ2o: $row["\x64\145\163\143\x72\151\x70\x74\151\x6f\156"] = ellipsisString($row["\144\x65\x73\143\162\x69\x70\x74\x69\157\x6e"], 32); goto IwLFA; xV5pY: $subjectNames = ''; goto VUsqg; YBsUr: $row["\163\165\142\152\x65\143\164\163\137\x6e\141\155\x65\x73"] = $subjectNames; goto J1_ek; VUsqg: $subjectIds = explode("\54", $row["\x73\x75\x62\x6a\145\x63\164\163"]); goto Qg26b; Qg26b: foreach ($subjectIds as $subjectId) { goto Qm_V8; Qm_V8: $subjectName = isset($subjectPairs[$subjectId]) ? $subjectPairs[$subjectId] : ''; goto HUl4N; CPDA2: $subjectNames .= $subjectName; goto IF1GH; dp66r: ZbX02: goto CPDA2; wLG12: $subjectNames .= "\x3c\x62\x72\x20\57\x3e"; goto dp66r; IF1GH: e0u1X: goto dYKu1; YEkrS: if (!$subjectNames) { goto ZbX02; } goto wLG12; HUl4N: if (!$subjectName) { goto e0u1X; } goto YEkrS; dYKu1: AnoPN: goto EyqK2; EyqK2: } goto NuOAv; pYhxD: } goto ZPiwx; IQ1pA: if ($sort == "\163\164\x61\164\x75\x73") { goto B9n7F; } goto nDNdP; jja8d: sAMBA: goto hwBPn; pzR8I: if (emptyInArray($search, "\163\x74\x61\x74\x75\163")) { goto Dp0v_; } goto NIRfl; w2B9P: if (emptyInArray($search, "\144\x65\154\145\x74\145\x5f\146\154\x61\x67")) { goto sAMBA; } goto ae2u6; ZPiwx: D5u_x: goto YaasY; YaasY: return ["\164\x6f\164\x61\154" => $count, "\162\x6f\x77\163" => $rows]; goto OTwzO; I0wTY: goto lOd5H; goto I8HWe; fsj3z: $where = ["\x64\x65\154\145\164\x65\x5f\146\154\x61\x67" => 0]; goto BIgZT; NIRfl: $where["\163\164\141\164\x75\x73"] = $search["\163\164\x61\164\165\x73"]; goto j0rSr; XTURL: lOd5H: goto fsj3z; BIgZT: if (!(isset($search["\156\141\155\x65"]) && $search["\x6e\141\155\145"])) { goto Y8yWy; } goto OZCtJ; ae2u6: $where["\144\145\x6c\x65\164\x65\x5f\146\154\x61\147"] = $search["\x64\x65\154\x65\x74\145\x5f\146\154\141\147"]; goto jja8d; CdZx8: $rows = Db::table("\163\165\142\x6a\x65\143\164\137\x63\157\155\x62\151\x6e\x61\164\151\157\156")->where($where)->page($page, $rows)->order($order)->field(true)->select(); goto K6kA9; lQw73: $subjectPairs = []; goto zw7W1; I8HWe: B9n7F: goto FTxBm; hsFRa: Y8yWy: goto pzR8I; Ra9zf: $subjectPairs = Db::table("\163\x75\142\x6a\x65\143\164")->where([])->column("\x6e\x61\155\145", "\151\x64"); goto kPYZu; nDNdP: $order = "\151\144\x20\144\x65\163\x63"; goto I0wTY; OTwzO: } public function getSubjectCombination($id) { $record = Db::table("\x73\165\142\x6a\x65\143\x74\137\143\157\155\x62\151\x6e\141\x74\x69\x6f\x6e")->where("\151\144", $id)->field("\52")->find(); return $record; } public function saveSubjectCombination($id, $data) { goto K42J9; ffpTu: $originals = Db::table("\x73\165\142\152\145\143\164\x5f\x63\x6f\155\142\x69\x6e\x61\164\151\x6f\156")->where(["\x69\x64" => $id])->field(true)->find(); goto L5AID; d3jYd: UzasG: goto kixsk; cejCF: wexception("\350\257\267\xe9\200\x89\xe6\x8b\xa9\xe9\207\x8f\350\241\xa8"); goto RxA4Q; LMe6f: $data["\155\164\151\155\145"] = date("\x59\x2d\155\x2d\144\40\x48\72\151\x3a\x73"); goto ffpTu; kixsk: if (!(count(explode("\54", $data["\x73\165\142\152\x65\x63\164\x73"])) > 20)) { goto f2DqP; } goto qjbU9; C8lnq: X0kGd: goto oHGPt; SwBjA: Ztc9N: goto JqdNK; IYvqH: OperationLogs::I()->subjecCombinationtLog("\xe4\xbf\xae\xe6\x94\271\xe7\xbb\204\xe5\x90\x88\351\x87\217\xe8\xa1\250\40\55\40{$data["\156\141\x6d\x65"]}", beautifyLogArray($data, $originals, "\163\165\142\152\145\143\164\x5f\143\157\x6d\142\151\x6e\x61\x74\151\x6f\156"), OperationLogs::OPT_UPDATE_TYPE, $id); goto vcte_; ykQwD: OperationLogs::I()->subjecCombinationtLog("\xe6\226\260\345\242\x9e\347\273\x84\xe5\x90\210\351\x87\x8f\350\241\250\40\55\40{$data["\x6e\141\x6d\x65"]}", beautifyLogArray($data, [], "\163\165\x62\x6a\145\143\164\137\x63\157\155\x62\151\156\141\x74\x69\157\x6e"), OperationLogs::OPT_ADD_TYPE, $id); goto SwBjA; LGHEI: $data["\x62\141\156\156\x65\x72"] = $banner; goto y1eU1; K42J9: if (!empty($data["\163\165\x62\x6a\145\143\x74\163"])) { goto QeKg7; } goto cejCF; y1eU1: L9mqy: goto RYddq; qjbU9: wexception("\xe4\xb8\215\350\203\xbd\xe9\200\x89\xe6\x8b\251\350\266\205\350\xbf\x87\62\x30\344\xb8\xaa\xe4\xbb\245\344\270\212\xe9\207\217\xe8\241\xa8"); goto Gb4M4; RYddq: if (empty($id)) { goto X0kGd; } goto LMe6f; oHGPt: $id = Db::table("\x73\x75\142\x6a\145\x63\164\137\x63\x6f\155\142\151\x6e\141\164\x69\157\x6e")->insertGetId($data); goto vBUBP; vBUBP: if (!empty($id)) { goto kjTKF; } goto jWs2b; RxA4Q: QeKg7: goto qvudK; vcte_: goto Ztc9N; goto C8lnq; L5AID: Db::table("\163\165\142\152\145\143\x74\137\143\x6f\155\142\151\x6e\141\x74\x69\x6f\x6e")->where(["\x69\144" => $id])->update($data); goto IYvqH; DBObu: $banner = autoGenerateBannerImage($data["\x6e\x61\x6d\145"], $data["\x62\141\156\156\x65\x72"]); goto dQzgV; FjiKB: kjTKF: goto ykQwD; dQzgV: if (!$banner) { goto L9mqy; } goto LGHEI; jWs2b: wexception("\346\xb7\273\xe5\212\xa0\xe5\xa4\261\xe8\xb4\245"); goto FjiKB; Gb4M4: f2DqP: goto DBObu; AbmIU: wexception("\xe8\257\267\351\200\x89\xe6\x8b\xa9\xe4\270\xa4\344\270\252\xe4\xbb\245\xe4\270\212\xe9\207\x8f\xe8\241\250"); goto d3jYd; qvudK: if (!(count(explode("\54", $data["\163\165\142\x6a\x65\143\x74\163"])) == 1)) { goto UzasG; } goto AbmIU; JqdNK: } public function deleteSubjectCombination($id) { goto z0QtX; qS61B: OperationLogs::I()->subjecCombinationtLog("\345\x88\xa0\351\231\244\347\273\x84\xe5\x90\210\351\207\217\xe8\241\xa8", $name, OperationLogs::OPT_DELETE_TYPE, $id); goto hGP41; p9Z5Y: $name = Db::table("\x73\165\x62\152\x65\x63\x74\x5f\x63\x6f\155\x62\151\156\141\x74\151\x6f\x6e")->where(["\x69\144" => $id])->value("\x6e\x61\155\145"); goto qS61B; z0QtX: Db::table("\x73\x75\142\x6a\x65\x63\x74\137\x63\x6f\155\142\x69\156\x61\x74\x69\x6f\x6e")->where(["\x69\144" => $id])->update(["\x64\145\154\145\x74\145\137\x66\x6c\141\147" => 1]); goto p9Z5Y; hGP41: } public function deleteForceSubjectCombination($id) { goto S4tvs; qxOie: Db::table("\x73\x75\142\152\x65\x63\164\x5f\157\162\x64\x65\162")->where(["\x63\x62\x5f\x6f\x72\144\145\162\137\x69\x64" => ["\x69\156", $orderIds]])->delete(); goto jRX3X; Gt_kH: if (!$orderIds) { goto ajV51; } goto qxOie; Sq04d: Db::table("\x63\157\155\142\151\156\141\164\151\157\156\137\157\x72\x64\x65\162")->where(["\x63\x6f\155\x62\151\x6e\141\x74\x69\x6f\156\x5f\x69\x64" => $id])->delete(); goto y4A8F; S4tvs: $orderIds = Db::table("\x63\x6f\x6d\x62\x69\156\141\164\x69\x6f\x6e\137\157\162\x64\x65\x72")->where(["\143\x6f\155\142\151\x6e\x61\164\151\x6f\156\x5f\151\x64" => $id])->column("\151\x64"); goto Gt_kH; y4A8F: Db::table("\163\165\x62\152\145\x63\x74\137\143\157\155\x62\151\x6e\141\164\x69\157\x6e")->where(["\151\x64" => $id])->delete(); goto VUpch; jRX3X: ajV51: goto Sq04d; VUpch: } public function qrcode($id) { goto VZUZ5; BA67p: REQ72: goto DEOAJ; gpLJW: $app = \EasyWeChat\Factory::officialAccount(config("\167\170\56\157\x66\x66\x69\143\x69\x61\x6c\x5f\x61\x63\x63\x6f\165\x6e\x74")); goto Zk7cc; XLnc0: Db::table("\x73\x75\142\152\145\x63\164\x5f\x63\x6f\x6d\x62\x69\x6e\x61\164\151\157\x6e")->where(["\151\144" => $id])->setField("\x71\162\143\157\144\x65", $path); goto qmNqY; DEOAJ: if (systemSetting("\127\x58\x5f\117\106\x46\111\103\x45\x5f\101\103\x43\x4f\125\116\124\137\x41\x50\x50\x5f\111\104")) { goto ZB3yQ; } goto MTVrl; s_juy: wexception("\345\206\231\xe5\205\245\345\233\xbe\345\x83\217\xe6\x96\x87\xe4\273\266\345\244\xb1\350\xb4\xa5"); goto iZ_H7; iZ_H7: m9leD: goto XLnc0; u7kjR: $result = file_put_contents(SITE_DIR . $path, file_get_contents($url)); goto CPwnK; fFfL8: $path = "\x2f\x71\x72\143\157\144\145\x2f" . $scene_id . "\x2e\x6a\x70\x67"; goto u7kjR; NENtP: wexception("\346\x97\xa0\xe6\263\225\xe6\211\xbe\xe5\210\260\350\xaf\xa5\351\207\x8f\xe8\xa1\xa8"); goto BA67p; OGPJb: if ($subject) { goto REQ72; } goto NENtP; Zk7cc: $scene_id = "\x63\157\x6d\142\151\156\141\x74\x69\x6f\x6e\x5f\x69\144\x5f" . $id; goto GpJgW; VZUZ5: $subject = Db::table("\x73\165\x62\152\x65\143\164\137\x63\x6f\x6d\142\151\156\141\164\151\157\156")->where(["\151\x64" => $id])->find(); goto OGPJb; GpJgW: try { goto ITPKi; ITPKi: $res = $app->qrcode->forever($scene_id); goto G2H4r; Kipjz: $url = $app->qrcode->url($res["\164\x69\143\x6b\145\x74"]); goto m_8el; G2H4r: if (!$res) { goto FsaOK; } goto BQLM1; wHkFE: FsaOK: goto IZpRi; BQLM1: Log::notice("\163\165\142\152\x65\x63\164\40\x63\157\x6d\x62\x69\x6e\141\164\151\x6f\156\x20\161\162\x63\157\144\x65\40\162\x65\x74\x75\162\156\40" . var_export($res, true)); goto wHkFE; Jy_Mx: exception("\346\x8e\xa5\345\x8f\xa3\350\277\x94\345\233\236\xe5\xa4\xb1\350\264\245\54\40" . var_export($res, true)); goto PKhf6; IZpRi: if (!(!$res || !isset($res["\164\x69\x63\x6b\x65\x74"]))) { goto JIeRS; } goto Jy_Mx; PKhf6: JIeRS: goto Kipjz; m_8el: } catch (\Exception $e) { wexception("\xe7\224\x9f\346\210\x90\xe5\xa4\261\350\264\245\xef\274\232" . $e->getMessage()); } goto fFfL8; qmNqY: return $path; goto j2yJ0; CPwnK: if ($result) { goto m9leD; } goto s_juy; K4yIm: ZB3yQ: goto gpLJW; MTVrl: wexception("\347\224\x9f\xe6\210\x90\xe5\244\261\350\xb4\245\357\274\232\xe6\x9c\xaa\xe9\x85\x8d\347\275\256\345\x85\xac\344\xbc\x97\345\x8f\267\345\x8f\202\xe6\225\xb0"); goto K4yIm; j2yJ0: } }
