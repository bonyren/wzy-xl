<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\service\RequestContext; class Messages extends Base { const MESSAGE_ADMIN_SYSTEM_CATEGORY = 1; public static $messageCategoryDefs = array(self::MESSAGE_ADMIN_SYSTEM_CATEGORY => "\347\263\273\xe7\273\237\xe9\x80\232\347\x9f\xa5"); public static $messageCategoryHtmlDefs = array(self::MESSAGE_ADMIN_SYSTEM_CATEGORY => "\74\x73\160\141\x6e\x20\x63\x6c\141\163\163\75\42\142\x61\144\x67\x65\x20\x62\x61\144\x67\145\x2d\x70\162\x69\155\141\x72\x79\x22\x3e\xe7\xb3\273\xe7\273\x9f\351\x80\232\xe7\x9f\xa5\x3c\x2f\163\160\x61\x6e\76"); protected function __construct() { parent::__construct(); } public function load($adminId, $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto RL34Q; kZcre: if ($sort == "\143\x61\x74\x65\147\x6f\162\x79") { goto ugcKv; } goto zqqVn; Hfw8S: return ["\x74\x6f\164\141\154" => $totalCount, "\162\157\x77\163" => $records]; goto iweyH; lnXaa: $records = Db::table("\x6d\x65\x73\163\x61\147\x65\163")->where($conditions)->limit($limit)->order($order)->field(["\x6d\145\163\163\141\147\x65\137\151\x64", "\141\x64\x6d\151\156\137\151\144", "\x74\151\164\x6c\145", "\x63\157\156\164\145\x6e\164", "\x63\141\x74\x65\x67\x6f\162\171", "\x69\163\137\162\145\141\144", "\x72\145\141\144\x5f\164\x69\x6d\145", "\x65\x6e\x74\x65\x72\145\x64"])->select(); goto xILXo; DvoDx: v1ZmV: goto Hfw8S; ALEsW: $conditions["\141\144\155\151\x6e\137\151\x64"] = $adminId; goto QEYCO; Oi6VD: if (!$adminId) { goto n7y0N; } goto ALEsW; CLs9_: $conditions = []; goto Oi6VD; iYJKj: goto SWgSU; goto OgJ7N; OgJ7N: ugcKv: goto ycsEQ; QEYCO: n7y0N: goto zfDyX; zfDyX: $totalCount = Db::table("\x6d\x65\x73\x73\141\147\145\x73")->where($conditions)->count(); goto lnXaa; zqqVn: $order = "\x6d\145\x73\x73\141\147\145\x5f\x69\144\40\144\x65\x73\143"; goto iYJKj; SyZ7P: SWgSU: goto CLs9_; ycsEQ: $order = "\143\x61\164\145\147\157\162\x79\40" . $order; goto SyZ7P; xILXo: foreach ($records as &$record) { $record["\143\x68\x65\143\153\x65\x64"] = true; BkzEK: } goto DvoDx; RL34Q: $limit = ($page - 1) * $rows . "\x2c" . $rows; goto kZcre; iweyH: } public function add($category, $title, $content, $adminId = 0) { goto wMMz6; vaV9Q: $messageId = Db::table("\x6d\145\163\x73\141\x67\x65\x73")->insertGetId($datas); goto xMKPi; xMKPi: return $messageId; goto MGiIM; wMMz6: $datas = ["\x61\x64\x6d\151\x6e\x5f\151\x64" => $adminId, "\164\x69\164\x6c\145" => mb_truncateString($title, 200), "\143\x6f\x6e\164\145\x6e\164" => $content, "\x63\x61\164\145\147\x6f\162\x79" => $category]; goto vaV9Q; MGiIM: } public function markRead($messageId) { Db::table("\155\145\163\163\x61\x67\145\x73")->where(["\155\145\x73\163\x61\147\x65\137\x69\144" => $messageId, "\151\x73\137\162\145\x61\x64" => 0])->update(["\151\x73\137\x72\145\x61\x64" => 1, "\x72\145\x61\144\137\164\x69\155\145" => date("\131\x2d\x6d\55\x64\40\x48\x3a\151\72\x73")]); return true; } public function markAllRead($adminId) { goto gRbj_; gRbj_: $conditions = ["\151\163\137\162\x65\x61\x64" => 0]; goto DpFUD; DpFUD: if (!$adminId) { goto z__m0; } goto lHMRt; eDHGu: Db::table("\x6d\x65\163\x73\141\147\145\163")->where($conditions)->update(["\x69\x73\137\162\145\141\144" => 1, "\162\145\141\x64\x5f\164\x69\x6d\145" => Db::raw("\x6e\157\167\50\x29")]); goto q02oX; MIU6f: z__m0: goto eDHGu; lHMRt: $conditions["\x61\144\155\151\x6e\137\x69\144"] = $adminId; goto MIU6f; q02oX: } public function markSelectedRead($messageIds) { Db::table("\155\x65\163\x73\141\x67\145\163")->where(["\x6d\x65\x73\163\141\147\x65\137\151\x64" => ["\151\156", $messageIds], "\x69\163\137\162\145\141\x64" => 0])->update(["\x69\x73\137\x72\145\141\x64" => 1, "\x72\x65\x61\x64\137\x74\151\155\x65" => Db::raw("\x6e\x6f\x77\x28\51")]); } public function getInfos($messageId) { $infos = Db::table("\x6d\145\163\163\x61\x67\145\x73")->where("\x6d\x65\x73\163\x61\147\145\x5f\151\x64", $messageId)->field(true)->find(); return $infos; } public function unreadCount($adminId) { goto B0aq7; B0aq7: $conditions = ["\x69\163\137\162\x65\141\x64" => 0]; goto OHpN0; OHpN0: if (!$adminId) { goto U88mi; } goto p6tr2; kY8J8: return $count; goto YwdtA; p6tr2: $conditions["\x61\x64\x6d\x69\x6e\137\151\x64"] = $adminId; goto vlOms; vlOms: U88mi: goto VJIHk; VJIHk: $count = Db::table("\x6d\x65\x73\163\x61\147\145\163")->where($conditions)->count(); goto kY8J8; YwdtA: } }
