<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\Defs; use app\index\logic\Defs as IndexDefs; use app\index\service\RequestContext; use app\index\model\Survey as SurveyModel; use app\index\service\OperationLogs; class Survey extends Base { public function __construct() { } public function loadSurvey($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto pcXyd; pqKAd: $conditions["\x64\145\154\145\164\145\137\146\154\141\x67"] = $search["\x64\145\154\145\x74\x65\137\x66\x6c\141\x67"]; goto Q3F2S; tKPp7: ZDJxL: goto gnoYF; poKOM: $order = "\x73\164\x61\x74\x75\x73\x20{$order}"; goto fiyny; Fzepj: if (!empty($subjectPairs)) { goto Icunq; } goto YhILS; pbi4j: $order = "\x69\x64\40\x64\145\x73\x63"; goto y7mpL; f0ViO: q4UYh: goto K2hVM; puQkw: $records = Db::table("\x73\x75\162\x76\145\171")->where($conditions)->page($page, $rows)->order($order)->field(true)->select(); goto qNCal; bFxlo: Be1Us: goto poKOM; PJEBy: Icunq: goto HrscG; AV0Qn: udsHY: goto Cx3YU; UDuOF: $conditions["\156\141\x6d\145"] = ["\x6c\x69\153\145", "\x25" . $search["\x6e\141\155\x65"] . "\x25"]; goto f0ViO; zrbm3: return ["\164\x6f\x74\x61\154" => $totalCount, "\x72\157\167\163" => $records]; goto PvOM5; qNCal: foreach ($records as &$record) { goto oox7O; bCzmf: $subjectIds = explode("\54", $record["\163\x75\142\152\145\143\164\x73"]); goto PFhBa; zdBbt: $record["\x73\x75\x62\x6a\145\x63\x74\x73\137\156\x61\155\145\163"] = $subjectNames; goto Q0cxE; oox7O: $subjectNames = ''; goto bCzmf; Ct9EU: $record["\x64\145\x73\x63\162\151\160\164\151\x6f\x6e"] = ellipsisString($record["\x64\x65\163\143\162\x69\160\164\x69\157\156"], 32); goto tRKo_; C53pS: $record["\143\157\x6d\160\154\145\164\145\144\137\x63\x6f\x75\x6e\x74"] = Db::table("\163\x75\162\x76\145\171\137\x6f\x72\x64\x65\162")->where(["\x73\165\162\166\x65\171\137\x69\144" => $record["\x69\144"], "\x66\151\x6e\x69\163\150\145\x64" => 1])->count(); goto h7FlB; Q0cxE: $record["\x62\141\x6e\156\x65\x72"] = generateThumbnailUrl($record["\x62\x61\156\156\x65\x72"], 100); goto C53pS; h7FlB: $record["\x77\x61\x72\156\x69\156\x67\x5f\143\x6f\x75\156\164"] = Db::table("\x73\x75\142\152\x65\x63\x74\137\x6f\162\x64\145\162")->where("\x73\x75\x72\166\x65\x79\137\x6f\x72\x64\145\162\x5f\151\x64", "\151\156", function ($query) use($record) { $query->table("\x73\165\162\x76\145\171\x5f\157\x72\144\145\162")->where(["\x73\165\x72\x76\145\x79\x5f\151\x64" => $record["\151\x64"], "\x66\151\156\151\x73\150\x65\144" => 1])->field("\x69\x64"); })->where("\x77\141\162\156\151\156\147\x5f\x6c\x65\166\x65\154", "\76", Defs::MEASURE_WARNING_GREEN_LEVEL)->group("\163\165\162\x76\x65\x79\137\157\162\x64\145\x72\137\151\x64")->count(); goto Ct9EU; zJSbE: z5pTJ: goto zdBbt; PFhBa: foreach ($subjectIds as $subjectId) { goto gPnfT; Ddx36: zW_zj: goto bcYJE; B1D3Y: gsT9U: goto O4xRF; gPnfT: $subjectName = isset($subjectPairs[$subjectId]) ? $subjectPairs[$subjectId] : ''; goto BnlJv; qQ1MT: if (!$subjectNames) { goto zW_zj; } goto Kf212; BnlJv: if (!$subjectName) { goto FkKBd; } goto qQ1MT; ZSWuP: FkKBd: goto B1D3Y; bcYJE: $subjectNames .= $subjectName; goto ZSWuP; Kf212: $subjectNames .= "\74\142\162\x20\x2f\76"; goto Ddx36; O4xRF: } goto zJSbE; tRKo_: ZGZ8h: goto bk3Py; bk3Py: } goto GeBVO; YhILS: $subjectPairs = []; goto PJEBy; fiyny: Hp3hW: goto fBoRa; Cx3YU: $conditions["\144\x65\x6c\145\164\145\x5f\146\x6c\x61\x67"] = 0; goto mZyWR; fBoRa: $conditions = []; goto JiLVS; gnoYF: $subjectPairs = Db::table("\x73\x75\x62\x6a\x65\143\x74")->where([])->column("\x6e\141\x6d\145", "\x69\x64"); goto Fzepj; pcXyd: if ($sort == "\x73\x74\x61\x74\x75\163") { goto Be1Us; } goto pbi4j; GeBVO: Y2kI7: goto zrbm3; y7mpL: goto Hp3hW; goto bFxlo; K2hVM: if (empty($search["\x73\164\141\x74\x75\x73"])) { goto ZDJxL; } goto r7KCN; JiLVS: if (!isset($search["\x64\145\154\x65\164\145\x5f\x66\154\141\x67"])) { goto udsHY; } goto pqKAd; HrscG: $totalCount = Db::table("\163\x75\162\166\x65\x79")->where($conditions)->count(); goto puQkw; r7KCN: $conditions["\163\x74\141\x74\x75\x73"] = $search["\x73\164\141\x74\x75\x73"]; goto tKPp7; oLAX0: if (empty($search["\156\141\x6d\145"])) { goto q4UYh; } goto UDuOF; mZyWR: k6DB2: goto oLAX0; Q3F2S: goto k6DB2; goto AV0Qn; PvOM5: } public function getDefaultSurvey() { return ["\x6e\141\x6d\x65" => '', "\142\x61\156\x6e\x65\162" => '', "\x64\145\163\143\x72\x69\160\x74\151\157\156" => '', "\163\165\142\x6a\145\143\x74\163" => '', "\x63\x66\x67\x5f\x66\162\x65\145" => 1, "\143\x66\x67\137\x65\x6e\164\x65\x72\137\160\x65\x72\x73\x6f\156\141\154\137\x64\141\x74\x61" => 1, "\143\146\x67\x5f\x70\x65\162\163\157\156\141\x6c\137\144\x61\x74\141" => "\156\141\x6d\x65\x2c\x73\145\x78\x2c\x61\147\x65\x2c\155\x6f\x62\x69\x6c\145", "\143\146\x67\x5f\166\x69\x65\167\137\x72\145\x70\x6f\x72\x74" => 0, "\163\x74\x61\164\165\163" => IndexDefs::ENTITY_DRAFT_STATUS]; } public function getSurvey($id) { $survey = Db::table("\163\x75\162\166\x65\x79")->where("\151\144", $id)->field("\52")->find(); return $survey; } public function saveSurvey($id, $formData) { goto ry3EY; rXC1E: $model = new SurveyModel(); goto zNSqt; BS6IL: JgOa8: goto rXC1E; UBlhV: goto NQffu; goto quZbB; Qs8KV: NQffu: goto qr3H5; WiYsx: $originals = Db::table("\163\165\x62\152\145\143\x74\137\x63\x6f\x6d\142\151\156\x61\164\151\x6f\x6e")->where(["\x69\144" => $id])->field(true)->find(); goto rlI5A; zNSqt: nhAHF: goto o5XV5; quZbB: IMCxJ: goto oCXKp; Y1R7U: goto nhAHF; goto BS6IL; e1flc: exception("\xe6\227\240\xe6\xb3\225\xe6\x89\276\345\210\260\350\257\245\351\207\x8f\350\xa1\xa8"); goto clopk; CLkH4: $formData["\155\164\x69\x6d\145"] = date("\x59\55\155\x2d\144\x20\x48\x3a\x69\x3a\x73"); goto Xf0Te; yDIW0: if ($model) { goto cDJhA; } goto e1flc; evjC9: xB_us: goto CLkH4; o5XV5: $banner = autoGenerateBannerImage($formData["\x6e\x61\155\x65"], $formData["\x62\141\156\x6e\x65\162"]); goto NFW8L; oCXKp: OperationLogs::I()->subjecCombinationtLog("\346\x96\xb0\345\xa2\236\xe6\231\256\346\237\xa5\x20\55\x20{$model->name}", beautifyLogArray($formData, [], "\x73\x75\x72\x76\x65\x79"), OperationLogs::OPT_ADD_TYPE, $model->id); goto Qs8KV; GcQBk: $model->allowField(true)->save(); goto Mhi1W; NFW8L: if (!$banner) { goto xB_us; } goto sY155; sY155: $formData["\x62\141\x6e\156\145\162"] = $banner; goto evjC9; Xf0Te: $model->data($formData); goto GcQBk; rlI5A: $model = SurveyModel::get($id); goto yDIW0; Mhi1W: if (empty($id)) { goto IMCxJ; } goto oGksh; oGksh: OperationLogs::I()->subjecCombinationtLog("\xe4\277\xae\xe6\224\271\xe6\x99\256\xe6\x9f\xa5\x20\55\x20{$model->name}", beautifyLogArray($formData, $originals, "\163\165\x72\x76\x65\x79"), OperationLogs::OPT_UPDATE_TYPE, $id); goto UBlhV; clopk: cDJhA: goto Y1R7U; ry3EY: if (empty($id)) { goto JgOa8; } goto WiYsx; qr3H5: } public function deleteSurvey($id) { goto OofCl; OofCl: $model = SurveyModel::get($id); goto JV3FI; DWMTG: exception("\346\x97\xa0\346\263\225\xe6\x89\xbe\xe5\210\260\xe8\xaf\245\351\207\x8f\350\241\250"); goto ryHdf; hZm1G: $model->data(["\x64\145\154\145\164\x65\137\x66\x6c\141\x67" => 1]); goto KFwnU; ryHdf: CUkbn: goto hZm1G; KFwnU: $model->save(); goto FdT8o; JV3FI: if ($model) { goto CUkbn; } goto DWMTG; FdT8o: } public function deleteForceSurvey($id) { goto DYOQv; ZmLLl: if (!$orderIds) { goto qnu6Y; } goto OpxbY; DYOQv: $orderIds = Db::table("\x73\165\162\166\x65\171\x5f\157\x72\144\x65\x72")->where(["\163\x75\162\x76\145\x79\x5f\x69\x64" => $id])->column("\151\144"); goto ZmLLl; lfmg8: Db::table("\x73\x75\x72\166\x65\171\137\157\x72\147\x61\x6e\151\x7a\141\164\151\157\x6e")->where(["\163\x75\x72\x76\x65\x79\x5f\x69\144" => $id])->delete(); goto xT99Y; mZW6l: qnu6Y: goto KIqOa; xT99Y: Db::table("\163\x75\162\x76\145\x79")->where(["\x69\144" => $id])->delete(); goto wfNLV; KIqOa: Db::table("\x73\165\x72\166\x65\171\x5f\157\x72\144\145\162")->where(["\163\x75\162\x76\x65\x79\x5f\x69\144" => $id])->delete(); goto lfmg8; OpxbY: Db::table("\163\x75\x62\x6a\x65\143\x74\137\157\162\144\145\162")->where(["\163\x75\x72\x76\x65\171\137\x6f\162\144\x65\162\x5f\x69\144" => ["\151\x6e", $orderIds]])->delete(); goto mZW6l; wfNLV: } }
