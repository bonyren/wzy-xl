<?php
 namespace app\index\logic; use think\Db; use think\Log; use app\index\model\Attachments as AttachmentsModel; use app\Defs; use app\index\logic\Defs as IndexDefs; class Attachments extends Base { const ATTACH_SUBJECT_MODEL_TABLE = 1; const ATTACH_SUBJECT_STANDARD_TABLE = 2; const ATTACH_SUBJECT_ITEM_TABLE = 3; const ATTACH_PROGRESS_LOGS = 4; public static $attachTypeDefs = array(self::ATTACH_SUBJECT_MODEL_TABLE => array("\154\141\142\x65\x6c" => "\346\xb5\213\350\xaf\204\346\250\241\xe5\236\213\350\xa1\xa8"), self::ATTACH_SUBJECT_STANDARD_TABLE => array("\154\141\x62\145\154" => "\xe6\265\x8b\xe8\xaf\204\345\276\227\345\x88\x86\350\257\x84\344\xbc\xb0\xe8\241\xa8"), self::ATTACH_SUBJECT_ITEM_TABLE => array("\x6c\141\142\x65\x6c" => "\346\265\x8b\350\257\x84\351\xa2\230\xe7\233\xae\xe8\241\xa8"), self::ATTACH_PROGRESS_LOGS => array("\154\141\142\x65\x6c" => "\xe8\xbf\233\xe5\xba\xa6\xe6\227\245\345\xbf\x97")); protected function __construct() { parent::__construct(); } public function insertAttach($originalName, $saveName, $mimeType, $fileSize, $description, $attachmentType, $externalId, $externalId2 = 0) { goto YAI3U; otkXn: $attachmentsModel->data(["\x6f\162\x69\147\151\156\x61\154\137\156\x61\155\x65" => $originalName, "\x73\141\166\x65\137\156\x61\x6d\145" => $saveName, "\155\151\155\x65\x5f\x74\x79\x70\145" => $mimeType, "\x64\145\x73\143\x72\x69\x70\x74\151\157\x6e" => $description, "\163\x69\172\145" => $fileSize, "\141\164\x74\x61\143\x68\155\x65\156\164\137\x74\x79\160\x65" => $attachmentType, "\x65\x78\x74\x65\x72\x6e\141\154\137\151\x64" => intval($externalId), "\145\x78\164\145\162\x6e\x61\154\137\x69\x64\x32" => intval($externalId2), "\145\156\x74\x65\162\145\x64" => Db::raw("\156\x6f\167\x28\51")]); goto FUp3R; YAI3U: $attachmentsModel = new AttachmentsModel(); goto otkXn; UdeQa: return $attachmentId; goto e1qPG; FUp3R: $attachmentsModel->save(); goto cb9tx; cb9tx: $attachmentId = $attachmentsModel->attachment_id; goto GDB6u; GDB6u: Log::notice("\164\x68\x65\x20\156\145\167\x20\x61\x74\x74\x61\143\150\x6d\145\156\164\40\151\144\x3a\x20" . $attachmentId); goto UdeQa; e1qPG: } public function getAttaches($attachmentType, $externalId, $externalId2 = 0) { goto pk0Q6; pk0Q6: if (!empty($externalId)) { goto gPlDE; } goto tvd3y; xlb5_: return $attaches; goto mmkke; HAjkc: iIqeW: goto w__iU; w__iU: $attaches = Db::table("\x61\164\164\141\143\150\x6d\x65\156\164\x73")->where($conditions)->field("\141\164\x74\141\143\x68\155\145\156\164\x5f\x69\144\54\15\xa\40\x20\40\x20\x20\x20\x20\40\40\40\x20\40\157\x72\151\147\151\156\x61\x6c\137\156\x61\155\145\x2c\xd\xa\x9\11\x9\163\x61\x76\x65\x5f\x6e\x61\x6d\x65\54\15\12\11\x9\11\155\x69\x6d\145\137\x74\171\x70\145\54\xd\12\x9\11\x9\144\x65\x73\143\x72\x69\x70\x74\x69\157\x6e\54\xd\12\11\x9\11\163\x69\172\145\x2c\xd\12\11\x9\x9\x61\164\164\141\143\150\x6d\145\156\x74\x5f\164\x79\x70\x65\x2c\xd\xa\11\x9\11\145\170\164\145\162\x6e\141\154\x5f\151\x64\54\15\xa\11\11\x9\145\x78\164\145\162\156\x61\x6c\x5f\151\144\62\54\15\12\x9\11\11\x65\x6e\164\145\162\145\144")->order("\x61\x74\x74\x61\143\150\155\145\156\164\x5f\151\144", "\144\145\163\143")->select(); goto xlb5_; CiCbG: $conditions["\145\x78\164\x65\162\156\141\154\x5f\x69\x64\62"] = $externalId2; goto HAjkc; tvd3y: return []; goto RzUNO; RzUNO: gPlDE: goto HgDId; HgDId: $conditions = ["\141\164\x74\141\x63\x68\155\x65\x6e\x74\x5f\164\171\160\145" => $attachmentType, "\x65\170\164\x65\162\x6e\141\x6c\137\151\x64" => $externalId, "\x73\x74\141\x74\165\163" => IndexDefs::ATTACHMENT_OK]; goto PTD5m; PTD5m: if (!$externalId2) { goto iIqeW; } goto CiCbG; mmkke: } public function getAttachById($attachmentId) { return Db::table("\141\x74\x74\x61\143\150\155\x65\x6e\x74\163")->where(["\x61\x74\164\x61\143\x68\155\145\156\x74\x5f\x69\144" => $attachmentId])->find(); } public function deleteAttach($attachmentId) { goto F9AZ9; F9AZ9: if (!($attachmentId && !is_array($attachmentId))) { goto bh8RN; } goto kURgl; whSp0: return true; goto OlbBI; y1g27: bh8RN: goto IF0yB; GUvzb: AttachmentsModel::where($where)->setField("\x73\x74\141\x74\165\x73", IndexDefs::ATTACHMENT_DEL); goto whSp0; kURgl: $attachmentId = explode("\54", $attachmentId); goto y1g27; IF0yB: $where["\141\164\x74\x61\x63\x68\155\x65\156\x74\137\x69\144"] = count($attachmentId) > 1 ? ["\151\156", $attachmentId] : $attachmentId[0]; goto GUvzb; OlbBI: } public function deleteAttaches($externalId, $attachmentType) { Db::table("\141\x74\164\x61\143\x68\x6d\x65\x6e\164\x73")->where(["\141\x74\164\x61\143\150\x6d\x65\x6e\x74\x5f\x74\171\160\x65" => $attachmentType, "\145\x78\164\x65\162\x6e\141\154\x5f\x69\x64" => $externalId, "\x73\164\141\x74\x75\163" => IndexDefs::ATTACHMENT_OK])->setField("\163\164\141\164\x75\x73", IndexDefs::ATTACHMENT_DEL); return true; } public function relateAttaches($attachment_ids, $external_id, $external_id2 = 0) { goto EpTuV; waLP0: $attachment_ids = explode("\54", $attachment_ids); goto x4ejY; K6Ihi: wC3hy: goto Mmoc9; KT4XX: $save["\145\170\x74\x65\x72\156\141\x6c\137\151\144\x32"] = $external_id2; goto wqYTC; vh0fP: Db::table("\141\164\164\141\x63\150\155\x65\156\x74\163")->where(["\x61\164\164\141\x63\150\155\145\156\164\137\151\144" => ["\x69\156", $attachment_ids]])->update($save); goto qpCbI; Mmoc9: if (is_array($attachment_ids)) { goto kV3uE; } goto waLP0; TW7cH: if (!$external_id2) { goto nuq89; } goto KT4XX; DpUC3: $save = []; goto lyTu1; x4ejY: kV3uE: goto DpUC3; lyTu1: $save["\x65\170\x74\145\162\156\x61\x6c\x5f\151\144"] = $external_id; goto TW7cH; wqYTC: nuq89: goto vh0fP; GnfzY: return; goto K6Ihi; EpTuV: if (!empty($attachment_ids)) { goto wC3hy; } goto GnfzY; qpCbI: } }
