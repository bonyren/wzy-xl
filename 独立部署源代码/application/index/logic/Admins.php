<?php
 namespace app\index\logic; use app\index\model\Setting as SettingModel; use app\index\service\RequestContext; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use think\Url; use think\Cache; use app\index\model\Admins as AdminsModel; use app\Defs; use app\index\logic\Defs as IndexDefs; use app\index\service\OperationLogs; use app\index\logic\LoginLogs as LoginLogsLogic; class Admins extends Base { protected function __construct() { parent::__construct(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = '', $order = '') { goto M583j; EJoF9: $order = "\x41\x2e\x6c\x61\x73\x74\137\x6c\x6f\147\151\x6e\137\x74\151\x6d\145\x20" . $order; goto JPdjL; YT7Mb: goto YV5VC; goto yBI85; b2IAW: YV5VC: goto jGg6m; M583j: if ($sort == "\144\x69\x73\x61\142\x6c\145\x64") { goto e0XUH; } goto l3bO4; IsXHe: goto glPiH; goto i2R13; UL0nf: $adminsTable = "\x61\144\x6d\151\156\163"; goto KvaX2; vGs3E: Q7RM3: goto UL0nf; l3bO4: if ($sort == "\154\141\x73\x74\137\154\157\147\x69\x6e\x5f\x74\x69\x6d\x65") { goto JQnr6; } goto mDZ80; jU46l: return ["\x74\157\164\x61\x6c" => $totalCount, "\162\x6f\x77\x73" => $records]; goto HJ4rX; dojoW: $conditions["\x72\145\141\x6c\156\x61\x6d\x65"] = ["\x6c\x69\153\x65", "\45" . $search["\162\145\x61\154\156\x61\x6d\145"] . "\x25"]; goto vGs3E; Cj1Nm: if (emptyInArray($search, "\162\145\x61\x6c\x6e\141\155\x65")) { goto Q7RM3; } goto dojoW; KvaX2: $adminRoleTable = "\141\144\155\x69\x6e\137\162\x6f\154\x65"; goto Mzz62; oWwRv: if (emptyInArray($search, "\154\x6f\147\151\x6e\x5f\x6e\x61\155\x65")) { goto Rh4bY; } goto Js1ve; HYN4y: $records = Db::table($adminsTable)->alias("\101")->join("{$adminRoleTable}\40\122", "\x41\x2e\x72\x6f\x6c\x65\x5f\151\x64\x3d\122\56\162\x6f\x6c\x65\x5f\151\144", "\x4c\105\x46\x54")->where($conditions)->page($page, $rows)->order($order)->field("\101\56\52\54\122\56\162\157\x6c\145\x5f\156\x61\155\145")->select(); goto jU46l; HjZI7: $order = "\x41\56\x64\x69\163\x61\142\154\145\144\x20" . $order; goto b2IAW; i2R13: JQnr6: goto EJoF9; yBI85: e0XUH: goto HjZI7; jGg6m: $conditions = []; goto oWwRv; mDZ80: $order = "\101\56\x61\144\155\151\156\137\151\144\40\144\x65\163\x63"; goto IsXHe; Js1ve: $conditions["\154\157\x67\x69\x6e\x5f\x6e\x61\155\145"] = trim($search["\154\x6f\147\x69\156\137\156\141\155\145"]); goto PO3lp; PO3lp: Rh4bY: goto Cj1Nm; JPdjL: glPiH: goto YT7Mb; Mzz62: $totalCount = Db::table($adminsTable)->alias("\101")->where($conditions)->count(); goto HYN4y; HJ4rX: } protected function password($password, $encrypt = '') { goto t2QSP; eiBpy: return $encrypt ? $pwd["\x70\x61\163\x73\167\157\162\144"] : $pwd; goto LESvL; DKoig: $pwd["\160\141\163\163\x77\157\162\144"] = md5(md5(trim($password)) . $pwd["\145\x6e\143\x72\171\160\164"]); goto eiBpy; t2QSP: $pwd = array(); goto JcYi_; JcYi_: $pwd["\x65\x6e\x63\162\x79\160\x74"] = $encrypt ? $encrypt : \think\helper\Str::random(6); goto DKoig; LESvL: } public function addAdmin($infos) { goto hBz1e; y8HaN: $infos["\x72\x6f\x6c\x65\x5f\151\144"] = 0; goto jK8QT; jK8QT: VC9J1: goto q1GRs; X9v00: $passwordInfos = $this->password($infos["\154\157\x67\151\x6e\x5f\160\x61\163\163\167\x6f\162\x64"]); goto WaWys; WaWys: $infos["\x6c\x6f\147\x69\x6e\137\160\141\163\163\x77\x6f\162\144"] = $passwordInfos["\x70\x61\x73\163\167\x6f\162\144"]; goto tlV9N; pZX3V: OperationLogs::I()->systemLog("\346\226\260\345\xa2\x9e\347\xae\241\xe7\220\206\345\x91\230", beautifyLogArray($infos, [], $adminsTable), OperationLogs::OPT_ADD_TYPE, $adminsModel->admin_id); goto ee2yc; ee2yc: return true; goto eKsgc; Gvi1v: $adminsModel = new AdminsModel(); goto R0TH7; wpYDm: if (!isset($infos["\163\165\160\145\x72\137\165\163\x65\x72"])) { goto VC9J1; } goto y8HaN; q1GRs: $adminsModel->allowField(true)->save($infos); goto pZX3V; hBz1e: $adminsTable = "\x61\x64\x6d\151\x6e\x73"; goto Gvi1v; R0TH7: $infos["\160\x61\x73\x73\x77\157\162\144\137\x63\x68\141\x6e\x67\x65\x64"] = date("\131\55\155\x2d\144"); goto X9v00; tlV9N: $infos["\x6c\157\147\x69\x6e\137\145\156\143\162\171\160\x74"] = $passwordInfos["\x65\156\x63\162\171\x70\x74"]; goto wpYDm; eKsgc: } public function editAdmin($adminId, $infos) { goto l4jwR; Nhmjv: $adminsModel = AdminsModel::get($adminId); goto VW8J8; l4jwR: $adminsTable = "\x61\x64\x6d\151\x6e\163"; goto Nhmjv; GzSdE: $infos["\x64\151\x73\141\x62\154\145\x64"] = Defs::eEnableStatus; goto ItF_E; RC7KX: $infos["\162\157\x6c\x65\x5f\151\x64"] = 0; goto d6ZQm; XrKWE: LxV6j: goto F0CKC; vXFOk: if (!isset($infos["\144\x69\163\x61\x62\x6c\145\x64"])) { goto H9UUo; } goto OnbP0; JvDcV: $adminsModel->data($infos); goto KRSxe; UuX13: exception("\xe6\227\240\346\xb3\x95\xe6\211\xbe\xe5\x88\260\350\xaf\245\xe7\256\241\xe7\x90\x86\xe5\221\x98"); goto XrKWE; ItF_E: xhhcX: goto JvDcV; wKHFu: v4hhY: goto m2sY4; WQLit: goto xhhcX; goto Frsye; m2sY4: return true; goto g9qRy; ZzWkz: goto pSDrD; goto O7ham; O7ham: qbZNo: goto RC7KX; F0CKC: if (isset($infos["\x73\165\160\x65\x72\137\165\x73\145\162"])) { goto qbZNo; } goto QITGu; d6ZQm: pSDrD: goto vXFOk; PnODJ: if (!$result) { goto v4hhY; } goto AGf6A; OnbP0: $infos["\x64\151\x73\141\142\x6c\145\x64"] = Defs::eDisabledStatus; goto WQLit; QITGu: $infos["\163\x75\x70\145\162\x5f\165\163\145\162"] = AdminsModel::eAdminCommonRole; goto ZzWkz; Frsye: H9UUo: goto GzSdE; KRSxe: $result = $adminsModel->allowField(true)->save(); goto PnODJ; VW8J8: if ($adminsModel) { goto LxV6j; } goto UuX13; AGf6A: OperationLogs::I()->systemLog("\344\277\xae\xe6\224\271\xe7\xae\241\347\x90\x86\xe5\221\x98", beautifyLogArray($infos, [], $adminsTable), OperationLogs::OPT_UPDATE_TYPE, $adminId); goto wKHFu; g9qRy: } public function deleteAdmin($adminId) { goto R5oaj; Teidp: WdWCW: goto cAdWG; coVFu: $adminsModel->delete(); goto ZFaab; ZFaab: return true; goto OiON7; R5oaj: $adminsModel = AdminsModel::get($adminId); goto DUGGC; cAdWG: OperationLogs::I()->systemLog("\xe5\210\240\351\x99\244\347\xae\241\347\x90\x86\345\x91\230", $adminsModel->login_name, OperationLogs::OPT_DELETE_TYPE, $adminId); goto coVFu; DUGGC: if ($adminsModel) { goto WdWCW; } goto UBWdR; UBWdR: exception("\346\x97\240\346\263\225\346\211\xbe\345\x88\xb0\350\xaf\xa5\347\xae\241\347\220\x86\345\x91\x98"); goto Teidp; OiON7: } public function changeAdminPwd($adminId, $infos) { goto rKVmD; mf9qZ: $result = $adminsModel->allowField(true)->save($datas); goto Ky9U8; p26Ts: $datas = []; goto tGJpr; Ky9U8: if (!$result) { goto o0zRZ; } goto hEa64; GR3QM: $datas["\x6c\x6f\x67\151\156\137\145\156\143\x72\171\160\x74"] = $passwordInfos["\145\x6e\x63\x72\171\160\164"]; goto mf9qZ; Qerpd: if ($adminsModel) { goto Gh_PQ; } goto Q3nTo; kBTh8: Gh_PQ: goto H9Hdq; Q3nTo: exception("\346\x97\240\346\263\225\346\211\xbe\345\x88\xb0\xe8\xaf\245\347\256\xa1\347\x90\206\xe5\221\230"); goto kBTh8; ak0pi: return true; goto bHnJq; hEa64: OperationLogs::I()->systemLog("\xe4\277\xae\346\224\xb9\xe7\xae\241\xe7\x90\x86\345\221\230\345\xaf\206\xe7\xa0\201", beautifyLogArray($infos), OperationLogs::OPT_OTHER_TYPE, $adminId); goto Pkz8M; B5F8b: $datas["\154\157\x67\151\156\x5f\x70\x61\x73\x73\167\157\x72\x64"] = $passwordInfos["\x70\x61\163\x73\167\157\162\144"]; goto GR3QM; H9Hdq: $newPassword = isset($infos["\x6c\157\147\x69\x6e\x5f\x70\x61\x73\163\167\x6f\x72\144"]) ? $infos["\154\157\147\x69\156\137\x70\x61\163\163\x77\157\162\144"] : ''; goto dgcPb; X9kFI: rLfii: goto p26Ts; nE1S8: exception("\346\226\260\xe5\257\x86\xe7\240\x81\351\x9d\x9e\346\xb3\225"); goto X9kFI; Pkz8M: o0zRZ: goto ak0pi; rKVmD: $adminsModel = AdminsModel::get($adminId); goto Qerpd; tGJpr: $passwordInfos = $this->password($newPassword); goto B5F8b; dgcPb: if (!empty($newPassword)) { goto rLfii; } goto nE1S8; bHnJq: } public function getAdminInfos($adminId) { $adminsModel = AdminsModel::get($adminId); return $adminsModel; } public function getAdminIds() { $adminIds = Db::table("\141\144\x6d\x69\x6e\x73")->where(["\x64\151\163\x61\142\x6c\145\144" => Defs::eEnableStatus])->column("\x61\x64\155\151\x6e\137\x69\144"); return $adminIds; } public function login($username, $password) { goto p4Gcl; Dgxeu: uQwRV: goto Xa2zQ; rO3FA: Session::set("\x6c\x61\x73\164\154\157\x67\x69\156\151\x70", request()->ip()); goto kv0FJ; crPj3: $loginLogsLogic = LoginLogsLogic::newObj(); goto oQ3Rz; YlAlX: MJ9Zh: goto UmYxx; P8GIg: if ($adminsModel) { goto uQwRV; } goto Dj77Q; vIMIF: Session::set("\154\x61\x73\x74\154\157\x67\x69\156\164\x69\x6d\x65", time()); goto rO3FA; T1MWX: Session::set("\x75\163\x65\162\x72\157\x6c\x65\x69\144", $adminsModel->role_id); goto DZAYK; OZ08l: return false; goto lYb8A; UmYxx: $encryptPassword = $this->password($password, $adminsModel->login_encrypt); goto vR2EA; LbC27: Session::set("\x75\x73\145\x72\x6e\141\x6d\x65", $adminsModel->login_name); goto IUS1u; aB3rh: $adminsModel->save(["\x6c\x61\163\x74\137\154\x6f\x67\151\x6e\137\164\x69\x6d\x65" => Db::raw("\x6e\157\x77\x28\51")]); goto egpYb; egpYb: return $adminsModel; goto YRGv8; kv0FJ: Cache::set("\x53\105\x53\123\x49\117\x4e\x5f\x49\x44\137" . $adminsModel->admin_id, session_id()); goto ZIGm7; IUS1u: Session::set("\162\x65\x61\x6c\156\141\x6d\145", $adminsModel->realname); goto T1MWX; Xa2zQ: if (!($adminsModel->disabled != Defs::eEnableStatus)) { goto MJ9Zh; } goto t3L1u; lYb8A: gNqw2: goto AaG3h; p4Gcl: $adminsModel = AdminsModel::get(["\x6c\x6f\147\x69\156\137\x6e\x61\155\x65" => $username]); goto P8GIg; AaG3h: Session::set("\x75\x73\145\x72\151\144", $adminsModel->admin_id); goto LbC27; vR2EA: if (!($encryptPassword != $adminsModel->login_password)) { goto gNqw2; } goto OZ08l; t3L1u: return false; goto YlAlX; ZIGm7: Cache::set("\x53\x49\124\105\137\125\x52\x4c", SITE_URL); goto crPj3; oQ3Rz: $loginLogsLogic->add($adminsModel->login_name, $adminsModel->admin_id, truncateString(request()->header("\x75\x73\x65\162\x2d\141\147\x65\156\164"), 100), request()->ip()); goto aB3rh; Dj77Q: return false; goto Dgxeu; DZAYK: Session::set("\163\x75\x70\145\x72\137\x75\x73\145\162", $adminsModel->super_user == AdminsModel::eAdminSuperRole); goto vIMIF; YRGv8: } public function logout() { Session::delete(["\165\x73\x65\x72\151\x64", "\165\163\145\162\156\x61\x6d\x65", "\162\145\141\x6c\x6e\x61\155\x65", "\x75\x73\145\x72\x72\157\x6c\x65\151\x64", "\163\x75\x70\x65\162\137\x75\163\x65\x72", "\x6c\x61\163\164\154\x6f\147\x69\x6e\x74\x69\155\x65", "\154\x61\163\164\154\157\147\x69\x6e\151\160"]); } public function modifyAdminPwd($adminId, $oldPassword, $newPassword) { goto iOzOO; zaDBn: $datas["\x6c\x6f\x67\x69\156\137\x70\x61\163\x73\x77\157\162\x64"] = $passwordInfos["\160\x61\163\163\167\157\x72\144"]; goto Kk10p; G2ifz: xoQl2: goto oQ753; w9FTf: $datas = []; goto tICeQ; Bxfa_: exception("\346\227\xa7\345\257\206\xe7\xa0\x81\351\224\231\xe8\257\257"); goto tsNKH; zPK4_: $result = $adminsModel->save($datas); goto kI66W; tsNKH: ovtmE: goto w9FTf; tICeQ: $passwordInfos = $this->password($newPassword); goto zaDBn; bfvgu: if (!($encryptPassword != $adminsModel->login_password)) { goto ovtmE; } goto Bxfa_; rjTDv: return true; goto MHbfp; iOzOO: $adminsModel = AdminsModel::get($adminId); goto J6BP2; b97Zo: exception("\346\x97\240\xe6\xb3\225\xe6\211\276\xe5\210\xb0\xe8\xaf\xa5\xe7\xae\xa1\347\220\x86\xe5\x91\230"); goto G2ifz; iqrFb: NF4bH: goto rjTDv; oQ753: $encryptPassword = $this->password($oldPassword, $adminsModel->login_encrypt); goto bfvgu; zIDvq: OperationLogs::I()->systemLog("\344\277\256\346\224\271\xe7\256\xa1\xe7\220\x86\xe5\221\x98\345\xaf\x86\xe7\xa0\201", beautifyLogArray($datas), OperationLogs::OPT_OTHER_TYPE, $adminId); goto iqrFb; Kk10p: $datas["\x6c\157\x67\151\x6e\x5f\x65\156\143\162\x79\160\164"] = $passwordInfos["\x65\x6e\x63\x72\171\x70\x74"]; goto zPK4_; kI66W: if (!$result) { goto NF4bH; } goto zIDvq; J6BP2: if ($adminsModel) { goto xoQl2; } goto b97Zo; MHbfp: } public function getAdminRolePairs() { return Db::table("\x61\x64\x6d\151\156\137\x72\157\x6c\145")->column("\162\157\154\x65\137\x69\x64\54\40\x72\157\154\x65\137\156\141\155\145"); } }
