<?php
 namespace app\index\logic; use app\index\model\Setting; use think\Debug; use think\Db; use think\Log; use think\Request; use think\Session; use app\index\service\RequestContext; use app\index\logic\Defs; use app\index\logic\Attachments as AttachmentsLogic; class ProgressLogs extends Base { const PROGRESS_LOG_ALL_CATEGORY = 0; const PROGRESS_LOG_FUND_COLLECT_CATEGORY = 1; const EVENT_LOG_FUND_MANAGE_CATEGORY = 2; const SHAREHOLDER_DECISION_CATEGORY = 3; const INVESTED_SUPPORT_CATEGORY = 5; const INVESTED_PROGRESS_CATEGORY = 6; const PROGRESS_LOG_PARTNER_CATEGORY = 7; public static $progressLogCategoryDefs = array(self::PROGRESS_LOG_FUND_COLLECT_CATEGORY => "\345\x9f\272\351\207\221\345\x8b\x9f\351\x9b\x86\350\xbf\x9b\xe5\272\xa6", self::EVENT_LOG_FUND_MANAGE_CATEGORY => "\xe5\237\272\xe9\207\221\xe7\256\xa1\347\x90\x86\344\272\x8b\xe4\273\266", self::SHAREHOLDER_DECISION_CATEGORY => "\344\274\x9a\xe8\256\256\xe5\x86\263\xe8\xae\xae", self::INVESTED_SUPPORT_CATEGORY => "\346\212\225\345\220\216\xe6\x94\xaf\xe6\214\x81", self::INVESTED_PROGRESS_CATEGORY => "\350\xbf\x9b\xe5\xb1\225\xe6\217\x8f\xe8\277\260", self::PROGRESS_LOG_PARTNER_CATEGORY => "\345\220\x88\xe4\274\x99\xe4\272\272\350\277\233\345\261\x95"); protected function __construct() { parent::__construct(); } public function load($search = array(), $page = 1, $rows = DEFAULT_PAGE_ROWS, $sort = "\160\162\157\x67\162\145\x73\163\x5f\x6c\x6f\x67\x5f\151\144", $order = "\x64\x65\163\143", $category = \app\index\logic\ProgressLogs::PROGRESS_LOG_ALL_CATEGORY, $externalId = 0) { goto p7TEU; jNiki: E1Iyn: goto OIVcg; KdYC8: Ygxe2: goto AwlJY; W1iqx: if ($sort == "\160\162\157\x67\x72\145\163\163\x5f\154\157\x67\x5f\151\x64") { goto Ygxe2; } goto bxHVA; yU92s: return ["\x74\157\x74\141\154" => $totalCount, "\162\x6f\x77\x73" => $records]; goto LYqA5; y8CVN: $contacts = Db::table("\143\x6f\156\x74\141\x63\x74\163")->where("\151\x64", "\151\x6e", $contact_ids)->column("\156\x61\x6d\x65", "\x69\x64"); goto vbo9a; hTrtE: foreach ($records as $v) { goto h3grE; BqaM8: $contact_ids[$v["\143\157\x6e\164\x61\x63\164\x5f\x69\x64\163"]] = $v["\143\x6f\x6e\x74\141\x63\164\x5f\151\x64"]; goto HtK1u; HtK1u: Tx33x: goto VLkZW; h3grE: $admin_ids[$v["\x61\144\155\151\156\137\151\144"]] = $v["\141\144\x6d\151\156\x5f\151\144"]; goto BqaM8; VLkZW: } goto FF_DU; OIVcg: $totalCount = Db::table("\x70\x72\157\147\x72\145\163\x73\137\x6c\157\x67\x73")->where($conditions)->count(); goto rFf72; M6zoD: $admin_ids = []; goto qR4Ym; edp3Y: $conditions = ["\x65\x78\164\x65\x72\156\141\154\x5f\x69\x64" => $externalId]; goto njSvE; p7TEU: $limit = ($page - 1) * $rows . "\54" . $rows; goto W1iqx; qVTIZ: foreach ($records as $k => $v) { goto YYvqC; YYvqC: if ($v["\143\x6f\156\164\x61\x63\164\x5f\x69\144"]) { goto ApfpB; } goto TozVI; tKlfM: YkFlp: goto S3Ilb; ANPzk: ApfpB: goto NNKvq; NNKvq: $records[$k]["\x72\x65\141\154\156\x61\x6d\x65"] = $contacts[$v["\x63\x6f\x6e\x74\141\x63\164\x5f\151\x64"]] . "\xef\274\210\351\241\271\347\233\256\346\x96\xb9\357\xbc\211"; goto qnDzT; CH_LV: goto Pm6wB; goto ANPzk; qnDzT: Pm6wB: goto tKlfM; TozVI: $records[$k]["\162\145\141\154\156\x61\x6d\x65"] = $admins[$v["\141\x64\x6d\x69\156\x5f\x69\x64"]]; goto CH_LV; S3Ilb: } goto le_JU; vbo9a: $admins = Db::table("\141\144\x6d\x69\x6e\x73")->where("\x61\x64\x6d\x69\156\137\151\144", "\151\x6e", $admin_ids)->column("\x72\145\x61\x6c\156\x61\x6d\145", "\x61\x64\x6d\151\x6e\137\x69\144"); goto qVTIZ; qR4Ym: $contact_ids = []; goto hTrtE; G8djf: goto Xh887; goto KdYC8; yWlAJ: Xh887: goto edp3Y; v26ZA: $conditions["\143\141\164\x65\147\157\162\x79"] = $category; goto jNiki; bxHVA: $order = "\160\162\x6f\147\162\x65\x73\163\x5f\154\157\147\137\x69\x64\40\x64\145\x73\143"; goto G8djf; rFf72: $records = Db::table("\160\x72\x6f\x67\162\145\x73\x73\x5f\x6c\157\x67\163")->where($conditions)->limit($limit)->order($order)->select(); goto M6zoD; njSvE: if (!$category) { goto E1Iyn; } goto v26ZA; le_JU: qXjum: goto yU92s; AwlJY: $order = "\x70\x72\x6f\147\x72\x65\x73\163\137\x6c\157\x67\x5f\x69\x64\40" . $order; goto yWlAJ; FF_DU: V4v1v: goto y8CVN; LYqA5: } public function get($id) { goto dWIwh; VpIdD: L10y2: goto tNBaE; tNBaE: return $row; goto PCVEE; dWIwh: $row = Db::table("\160\x72\157\x67\x72\145\x73\x73\x5f\154\157\147\x73")->where("\160\x72\157\147\x72\145\x73\x73\x5f\154\x6f\147\137\151\144", $id)->find(); goto xQ5mp; xQ5mp: if (!empty($row)) { goto L10y2; } goto ngo25; ngo25: $row = []; goto VpIdD; PCVEE: } public function add($category, $externalId, $infos) { goto JuAM7; SQx4U: return true; goto tcBkf; j5Ly6: $datas["\x74\x69\x74\x6c\145"] = empty($infos["\x74\151\164\154\145"]) ? '' : $infos["\x74\x69\164\x6c\x65"]; goto OGBoB; IMK9z: $newProgressLogId = Db::table("\160\x72\x6f\x67\162\x65\163\x73\137\154\157\x67\x73")->insertGetId($datas); goto N6rQ2; SWfH4: $datas["\163\x68\x6f\x77\137\x74\x69\x6d\x65\154\x69\156\x65"] = intval($infos["\163\x68\x6f\167\137\164\x69\155\145\154\x69\x6e\x65"]); goto IMK9z; xk1PC: $datas["\157\x63\x63\x75\x72\137\144\x61\x74\x65"] = !emptyInArray($infos, "\157\143\143\165\x72\x5f\x64\141\x74\145") ? $infos["\x6f\x63\143\165\x72\137\x64\141\x74\145"] : Defs::DEFAULT_DB_DATE_VALUE; goto j5Ly6; OGBoB: $datas["\145\156\x74\162\x79"] = !emptyInArray($infos, "\x65\156\164\x72\x79") ? $infos["\145\156\x74\x72\x79"] : ''; goto aVH38; aVH38: $datas["\x65\x6e\x74\x65\x72\x65\144"] = date("\131\x2d\x6d\x2d\x64\x20\x48\x3a\151\72\x73"); goto YLAkR; JuAM7: $datas = []; goto olv_r; xCH0f: AttachmentsLogic::I()->relateAttaches($infos["\x61\164\x74\x61\143\x68\145\x73"], $newProgressLogId); goto sGsAf; olv_r: $datas["\143\x61\x74\x65\147\x6f\x72\171"] = $category; goto sPxiS; YLAkR: $datas["\x61\144\x6d\x69\156\137\x69\x64"] = intval(RequestContext::I()->loginUserId); goto SWfH4; sPxiS: $datas["\x65\x78\164\x65\162\x6e\x61\x6c\x5f\151\x64"] = $externalId; goto xk1PC; sGsAf: JJArJ: goto SQx4U; N6rQ2: if (!$infos["\141\164\164\141\x63\150\145\163"]) { goto JJArJ; } goto xCH0f; tcBkf: } public function delete($progressLogId) { goto KwFsc; KwFsc: AttachmentsLogic::I()->deleteAttaches($progressLogId, AttachmentsLogic::ATTACH_PROGRESS_LOGS); goto GLuDt; GLuDt: $result = Db::table("\160\162\x6f\147\162\x65\x73\163\x5f\154\157\147\x73")->where("\x70\162\157\x67\162\145\163\x73\137\x6c\x6f\147\x5f\151\x64", $progressLogId)->delete(); goto J5948; J5948: return $result > 0 ? true : false; goto mLUeg; mLUeg: } }
