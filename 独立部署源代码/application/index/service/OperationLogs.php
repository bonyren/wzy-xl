<?php
 namespace app\index\service; use think\Log; use think\Db; use think\Debug; use think\Request; use app\index\service\RequestContext; use app\Defs; use app\index\logic\Defs as IndexDefs; class OperationLogs extends Base { protected function __construct() { parent::__construct(); } const CATEGORY_SYSTEM = 0; const CATEGORY_EXPERT = 1; const CATEGORY_SUBJECT = 2; const CATEGORY_SUBJECT_COMBINATION = 3; const CATEGORY_SURVEY = 4; const CATEGORY_ORDER = 5; const CATEGORY_DEFS = array(self::CATEGORY_SYSTEM => "\347\xb3\xbb\xe7\xbb\x9f", self::CATEGORY_EXPERT => "\344\xb8\x93\345\xae\266", self::CATEGORY_SUBJECT => "\351\207\x8f\350\xa1\xa8", self::CATEGORY_SUBJECT_COMBINATION => "\xe7\xbb\204\xe5\x90\x88\351\x87\x8f\xe8\241\xa8", self::CATEGORY_SURVEY => "\346\231\256\346\237\xa5", self::CATEGORY_ORDER => "\350\256\242\345\215\225"); const OPT_ADD_TYPE = 1; const OPT_UPDATE_TYPE = 2; const OPT_DELETE_TYPE = 3; const OPT_RESTORE_TYPE = 4; const OPT_OTHER_TYPE = 5; const OPT_DEFS = array(self::OPT_ADD_TYPE => "\xe6\226\xb0\xe5\xa2\x9e", self::OPT_UPDATE_TYPE => "\xe4\277\xae\xe6\224\271", self::OPT_DELETE_TYPE => "\xe5\x88\240\xe9\231\244", self::OPT_RESTORE_TYPE => "\346\x81\xa2\xe5\244\215", self::OPT_OTHER_TYPE => "\xe5\205\266\xe4\273\x96"); const CHANNEL_ADMIN = 1; const CHANNEL_CLI = 3; const CHANNEL_DEFS = array(self::CHANNEL_ADMIN => "\347\xae\xa1\xe7\220\206\xe7\xab\xaf", self::CHANNEL_CLI => "\346\216\247\xe5\x88\xb6\xe5\x8f\260"); public function systemLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { return $this->log(self::CATEGORY_SYSTEM, $title, $content, $type, $entityId); } public function expertLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto HK8ug; vxnm1: return $this->log(self::CATEGORY_EXPERT, $title, $content, $type, $entityId); goto Rwprz; HK8ug: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto yWE2l; } goto IbYrq; IbYrq: return; goto vFheR; vFheR: yWE2l: goto vxnm1; Rwprz: } public function subjectLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto IRDma; A5rDL: QhQac: goto xksQ3; IRDma: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto QhQac; } goto eqh4r; xksQ3: return $this->log(self::CATEGORY_SUBJECT, $title, $content, $type, $entityId); goto JLlMX; eqh4r: return; goto A5rDL; JLlMX: } public function subjecCombinationtLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto Caakv; ox5mQ: return; goto B3JbD; lkg2X: return $this->log(self::CATEGORY_SUBJECT_COMBINATION, $title, $content, $type, $entityId); goto fOSRN; Caakv: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto kH_1Z; } goto ox5mQ; B3JbD: kH_1Z: goto lkg2X; fOSRN: } public function surveyLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto MhKhS; mXOey: Qh6aj: goto LmG1u; MhKhS: if (!($type == self::OPT_UPDATE_TYPE && $content == '')) { goto Qh6aj; } goto JFuT2; LmG1u: return $this->log(self::CATEGORY_SURVEY, $title, $content, $type, $entityId); goto zFdA_; JFuT2: return; goto mXOey; zFdA_: } public function orderLog($title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { return $this->log(self::CATEGORY_ORDER, $title, $content, $type, $entityId); } public function log($category = OperationLogs::CATEGORY_EXPERT, $title = '', $content = '', $type = OperationLogs::OPT_ADD_TYPE, $entityId = 0) { goto wVCeT; sGvo0: $changed_by = RequestContext::I()->loginUserName . "\50" . RequestContext::I()->loginRealName . "\51"; goto cAr9R; I1W8E: $device = Defs::DEVICE_DESKTOP; goto vRu6g; OWyRK: if (RequestContext::I()->loginUserId) { goto z9rVW; } goto H0T3I; d0rny: $channel = self::CHANNEL_ADMIN; goto uGS8d; kvN7e: $ip = "\x31\62\67\56\x30\56\60\56\61"; goto I1W8E; wVCeT: if (request()->isCli()) { goto Pay2Q; } goto OWyRK; ECwtb: o7SbS: goto z6HB7; eDrIz: $ip = request()->ip(); goto EJwVN; nLfa9: z9rVW: goto sGvo0; uGS8d: goto o7SbS; goto djYR7; H0T3I: $changed_by = ''; goto cj9ey; djYR7: Pay2Q: goto Bq7Di; Bq7Di: $changed_by = "\xe6\216\247\xe5\210\xb6\xe5\x8f\260"; goto kvN7e; z6HB7: $result = Db::table("\157\x70\x65\162\x61\x74\x69\x6f\156\137\154\157\147\x73")->insert(["\x63\x61\x74\145\x67\x6f\x72\x79" => $category, "\x74\x69\164\x6c\x65" => truncateString($title, 128), "\143\x6f\156\x74\x65\156\x74" => truncateString($content, 4096), "\164\x79\x70\145" => $type, "\x72\x65\x63\x6f\162\x64\137\151\x64" => $entityId, "\151\x70" => $ip, "\x64\x65\166\x69\143\145" => $device, "\143\x68\141\x6e\x67\145\144\x5f\x62\x79" => $changed_by]); goto WNPnZ; cj9ey: goto y71tG; goto nLfa9; vRu6g: $channel = self::CHANNEL_CLI; goto ECwtb; cAr9R: y71tG: goto eDrIz; EJwVN: $device = Request::instance()->isMobile() ? Defs::DEVICE_MOBILE : Defs::DEVICE_DESKTOP; goto d0rny; WNPnZ: return $result == 1 ? true : false; goto etr1V; etr1V: } }
